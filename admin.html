<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel</title>
  <style>/* styles unchanged */</style>
</head>
<body>
  <header>…</header>
  <div class="container">
    <!-- UI markup unchanged -->
  </div>
  <div class="modal" id="editModal">…</div>  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import {
      getFirestore, collection, getDocs, doc, updateDoc, query, where
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    const firebaseConfig = { /* your config */ };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const adminEmail = "easypay27.ng@gmail.com";

    let allUsers = [];
    let selectedUserId = null;

    onAuthStateChanged(auth, user => {
      console.log('Auth state changed, user:', user);
      if (!user || user.email.toLowerCase() !== adminEmail) {
        console.error('Unauthorized or no user, redirecting');
        signOut(auth).then(() => window.location.href = 'login.html');
      } else {
        console.log('Admin authenticated, loading users');
        loadUsers();
      }
    });

    async function loadUsers() {
      const tbody = document.getElementById("userTableBody");
      const countEl = document.getElementById("userCount");
      tbody.innerHTML = '<tr><td colspan="6" class="no-data">Loading users...</td></tr>';

      try {
        console.log('Fetching users from Firestore');
        const snapshot = await getDocs(collection(db, "users"));
        console.log('Fetched users, count:', snapshot.size);
        const rows = [];
        for (const docSnap of snapshot.docs) {
          const data = docSnap.data();
          const username = data.username || "—";
          const uid = docSnap.id;
          const balance = data.balance || 0;
          const suspended = data.suspended || false;
          const refSnap = await getDocs(query(collection(db, "users"), where("referral", "==", username)));
          const referralCount = refSnap.size;
          rows.push({ uid, username, balance, suspended, referralCount });
        }
        allUsers = rows;
        countEl.textContent = `Total Users: ${rows.length}`;
        renderTable(allUsers);
      } catch (error) {
        console.error('Error in loadUsers:', error);
        tbody.innerHTML = '<tr><td colspan="6" class="no-data">Error loading users. Check console.</td></tr>';
      }
    }

    function renderTable(users) {
      const tbody = document.getElementById("userTableBody");
      tbody.innerHTML = "";
      if (!users.length) {
        tbody.innerHTML = '<tr><td colspan="6" class="no-data">No users found.</td></tr>';
        return;
      }
      users.forEach(u => {
        /* row rendering unchanged */
      });
    }

    document.getElementById("searchBtn").onclick = () => {
      console.log('Search clicked');
      const q = document.getElementById("searchInput").value.trim().toLowerCase();
      console.log('Search query:', q);
      const filtered = allUsers.filter(u => u.username.toLowerCase().includes(q) || u.uid.toLowerCase().includes(q));
      renderTable(filtered);
    };

    /* openModal, saveChanges, toggleSuspend unchanged */

    window.addEventListener('click', e => {
      if (!e.target.closest('.dropdown')) document.getElementById('dropdownMenu').style.display = 'none';
    });
    window.toggleDropdown = () => {
      const menu = document.getElementById('dropdownMenu');
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    };
  </script></body>
</html>
