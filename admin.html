<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel</title>
  <style>
    :root { --green:#2e7d32; --light-green:#e8f5e9; --white:#ffffff; --gray:#f9f9f9; --shadow:0 2px 8px rgba(0,0,0,0.1); }
    body { font-family:'Segoe UI',sans-serif; background:var(--gray); margin:0; padding:0; }
    header { background:var(--green); color:var(--white); padding:1rem 2rem; display:flex; justify-content:space-between; align-items:center; box-shadow:var(--shadow); }
    h1 { font-size:1.5rem; margin:0; }
    .dropdown { position:relative; }
    .top-button { background:var(--white); color:var(--green); border:none; padding:.5rem 1rem; border-radius:8px; font-weight:bold; cursor:pointer; box-shadow:var(--shadow); }
    .dropdown-content { display:none; position:absolute; background:var(--white); min-width:180px; box-shadow:var(--shadow); z-index:1000; border-radius:8px; margin-top:8px; }
    .dropdown-content a { padding:12px 16px; display:block; text-decoration:none; color:#333; font-weight:500; }
    .dropdown-content a:hover { background:var(--light-green); }
    .container { padding:2rem; }
    #userCount { font-size:1.1rem; margin-bottom:10px; font-weight:500; color:#004400; }
    .search-group { display:flex; gap:10px; margin-bottom:1rem; }
    .search-group input { padding:.5rem; flex:1; border:1px solid #ccc; border-radius:5px; box-shadow:var(--shadow); }
    .search-group button { padding:.5rem 1rem; background:var(--green); color:var(--white); border:none; border-radius:5px; cursor:pointer; }
    table { width:100%; border-collapse:collapse; background:var(--white); border-radius:8px; overflow:hidden; box-shadow:var(--shadow); }
    th, td { padding:1rem; text-align:left; border-bottom:1px solid #eee; }
    th { background:var(--light-green); font-weight:600; }
    .btn { padding:.5rem 1rem; border:none; border-radius:5px; font-weight:bold; cursor:pointer; margin-right:.5rem; }
    .edit-btn { background:#4caf50; color:#fff; }
    .suspend-btn { background:#ff9800; color:#fff; }
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); justify-content:center; align-items:center; z-index:2000; }
    .modal-content { background:var(--white); padding:2rem; border-radius:12px; width:90%; max-width:400px; box-shadow:var(--shadow); }
    .no-data { text-align:center; padding:1rem; color:#666; }
  </style>
</head>
<body>
  <header>
    <h1>Admin Panel</h1>
    <div class="dropdown">
      <button class="top-button" onclick="toggleDropdown()">Menu</button>
      <div class="dropdown-content" id="dropdownMenu">
        <a href="admin-withdraw.html">Withdrawals</a>
        <a href="admin-deposit.html">Deposits</a>
        <a href="admin-advertise.html">Adverts</a>
        <a href="admin-task.html">Submissions</a>
        <a href="admin-activate.html">User Records</a>
        <a href="admin-plans.html">User Plans</a>
        <a href="admin-upgrade.html">Upgrades</a>
      </div>
    </div>
  </header>  <div class="container">
    <div id="userCount">Total Users: 0</div>
    <div class="search-group">
      <input type="text" id="searchInput" placeholder="Search by Username or UID..." />
      <button id="searchBtn">Search</button>
    </div>
    <table>
      <thead>
        <tr><th>Username</th><th>UID</th><th>Balance</th><th>Referrals</th><th>Status</th><th>Actions</th></tr>
      </thead>
      <tbody id="userTableBody"><tr><td colspan="6" class="no-data">Loading users...</td></tr></tbody>
    </table>
  </div>  <div class="modal" id="editModal">
    <div class="modal-content">
      <h3>Edit User</h3>
      <input type="text" id="editUsername" placeholder="Username" />
      <input type="number" id="editBalance" placeholder="Balance" />
      <input type="number" id="editReferrals" placeholder="Referrals" />
      <button class="btn edit-btn" onclick="saveChanges()">Save Changes</button>
    </div>
  </div>  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc,updateDoc, query, where } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDRkip46Ql5KhNfuatWAcAxQzgP5VtQ8UY",
      authDomain: "easypay-6bce8.firebaseapp.com",
      projectId: "easypay-6bce8",
      storageBucket: "easypay-6bce8.appspot.com",
      messagingSenderId: "862671358267",
      appId: "1:862671358267:web:b243c7b69840ef918c8f1e"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const adminEmail = "easypay27.ng@gmail.com";

    let allUsers = [];
    let selectedUserId = null;

    onAuthStateChanged(auth, user => {
      if (!user || user.email.toLowerCase() !== adminEmail) {
        signOut(auth).then(()=>window.location.href='login.html');
      } else {
        loadUsers();
      }
    });

    async function loadUsers() {
      const tbody = document.getElementById("userTableBody");
      const countEl = document.getElementById("userCount");
      try {
        tbody.innerHTML = '<tr><td colspan="6" class="no-data">Loading users...</td></tr>';
        const snapshot = await getDocs(collection(db, "users"));
        const rows = [];
        for (const docSnap of snapshot.docs) {
          const data = docSnap.data();
          const username = data.username || "—";
          const uid = docSnap.id;
          const balance = data.balance || 0;
          const suspended = data.suspended || false;
          const refSnap = await getDocs(query(collection(db, "users"), where("referral", "==", username)));
          const referralCount = refSnap.size;
          rows.push({ uid, username, balance, suspended, referralCount });
        }
        allUsers = rows;
        countEl.textContent = `Total Users: ${rows.length}`;
        renderTable(allUsers);
      } catch (error) {
        tbody.innerHTML = '<tr><td colspan="6" class="no-data">Error loading users.</td></tr>';
        console.error(error);
      }
    }

    function renderTable(users) {
      const tbody = document.getElementById("userTableBody");
      tbody.innerHTML = "";
      if (!users.length) {
        tbody.innerHTML = '<tr><td colspan="6" class="no-data">No users found.</td></tr>';
        return;
      }
      users.forEach(u => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${u.username}</td>
          <td>${u.uid}</td>
          <td>₦${u.balance}</td>
          <td>${u.referralCount}</td>
          <td>${u.suspended ? "Suspended" : "Active"}</td>
          <td>
            <button class="btn edit-btn" onclick="openModal('${u.uid}','${u.username}',${u.balance},${u.referralCount})">Edit</button>
            <button class="btn suspend-btn" onclick="toggleSuspend('${u.uid}',${u.suspended})">${u.suspended ? 'Unsuspend' : 'Suspend'}</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    document.getElementById("searchBtn").onclick = () => {
      const q = document.getElementById("searchInput").value.trim().toLowerCase();
      const filtered = allUsers.filter(u => u.username.toLowerCase().includes(q) || u.uid.toLowerCase().includes(q));
      renderTable(filtered);
    };

    window.openModal = (id, username, balance, referrals) => {
      selectedUserId = id;
      document.getElementById("editUsername").value = username;
      document.getElementById("editBalance").value = balance;
      document.getElementById("editReferrals").value = referrals;
      document.getElementById("editModal").style.display = "flex";
    };

    window.saveChanges = async () => {
      const username = document.getElementById("editUsername").value;
      const balance = parseFloat(document.getElementById("editBalance").value);
      const referrals = parseInt(document.getElementById("editReferrals").value);
      if (selectedUserId) {
        await updateDoc(doc(db, "users", selectedUserId), { username, balance, referrals });
        document.getElementById("editModal").style.display = "none";
        loadUsers();
      }
    };

    window.toggleSuspend = async (id, currently) => {
      if (confirm(`Are you sure you want to ${currently ? 'unsuspend' : 'suspend'} this user?`)) {
        await updateDoc(doc(db, "users", id), { suspended: !currently });
        loadUsers();
      }
    };

    window.addEventListener('click', e => {
      if (!e.target.closest('.dropdown')) document.getElementById('dropdownMenu').style.display = 'none';
    });
    window.toggleDropdown = () => {
      const menu = document.getElementById('dropdownMenu');
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    };
  </script></body>
</html>
