<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>My Tasks &amp; Submissions</title>
  <style>
    /* Global */
    body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: #f8fff8; color: #003300; }
    header { background: #006400; color: #fff; padding: 16px; text-align: center; font-size: 1.5em; font-weight: bold; }
    button { cursor: pointer; border: none; border-radius: 6px; font-weight: bold; }
    details { background: #fff; border-radius: 6px; margin-bottom: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    summary { padding: 12px 16px; font-weight: bold; background: #e6f4e6; cursor: pointer; }
    /* Login */
    #loginDiv { max-width: 360px; margin: 80px auto; padding: 24px; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,100,0,0.1); text-align: center; }
    #loginDiv input, #loginDiv button { width: 100%; margin: 8px 0; padding: 10px; }
    #loginDiv button { background: #006400; color: #fff; }
    #loginError { color: #cc0000; }
    /* Dashboard */
    #dashboard { display: none; padding: 20px; }
    #logoutBtn { float: right; background: #cc0000; color: #fff; padding: 8px 12px; margin-bottom: 12px; border-radius: 6px; }
    h2.task-title { margin: 24px 0 8px; color: #006400; }
    /* Table */
    .sub-table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 8px; overflow: hidden; margin: 0; }
    .sub-table th, .sub-table td { padding: 12px 16px; border-bottom: 1px solid #e0e0e0; text-align: left; }
    .sub-table th { background: #e6f4e6; color: #004400; }
    .approve-btn { background: #009900; color: #fff; padding: 6px 12px; margin-right: 4px; }
    .reject-btn  { background: #cc0000; color: #fff; padding: 6px 12px; }
    .view-btn    { background: #0066cc; color: #fff; padding: 6px 12px; }
  </style>
</head>
<body>
  <header>My Tasks &amp; Submissions</header>
  <p style="text-align:center; margin-top:8px; color:#004400; font-size:0.9em;">
    Payouts are calculated at 70% of the task cost (decimals allowed).
  </p>  <!-- Login Form -->  <div id="loginDiv">
    <h2>Sign In</h2>
    <input id="email"    type="email"    placeholder="Email"/><br>
    <input id="password" type="password" placeholder="Password"/><br>
    <button id="loginBtn">Sign In</button>
    <p id="loginError"></p>
  </div>  <!-- Dashboard -->  <div id="dashboard">
    <button id="logoutBtn">Sign Out</button>
    <div id="tasksContainer"></div>
  </div>  <!-- Firebase SDKs -->  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDRkip46Ql5KhNfuatWAcAxQzgP5VtQ8UY",
      authDomain: "easypay-6bce8.firebaseapp.com",
      projectId: "easypay-6bce8",
      storageBucket: "easypay-6bce8.appspot.com",
      messagingSenderId: "862671358267",
      appId: "1:862671358267:web:b243c7b69840ef918c8f1e"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(), db = firebase.firestore();

    // DOM refs
    const loginDiv       = document.getElementById("loginDiv");
    const dashboardDiv   = document.getElementById("dashboard");
    const tasksContainer = document.getElementById("tasksContainer");
    const loginBtn       = document.getElementById("loginBtn");
    const logoutBtn      = document.getElementById("logoutBtn");
    const loginError     = document.getElementById("loginError");
    const emailInput     = document.getElementById("email");
    const passInput      = document.getElementById("password");

    // Sign in/out
    loginBtn.onclick = () => {
      loginError.textContent = "";
      auth.signInWithEmailAndPassword(emailInput.value, passInput.value)
        .catch(e => loginError.textContent = e.message);
    };
    logoutBtn.onclick = () => auth.signOut();

    // Auth listener
    auth.onAuthStateChanged(user => {
      if (user) {
        loginDiv.style.display     = "none";
        dashboardDiv.style.display = "block";
        loadOwnerTasks(user.uid);
      } else {
        dashboardDiv.style.display = "none";
        loginDiv.style.display     = "block";
        tasksContainer.innerHTML   = "";
      }
    });

    // Load tasks + submissions with collapsible status sections
    async function loadOwnerTasks(uid) {
      tasksContainer.innerHTML = "";

      // Preload users map
      const usersData = {};
      (await db.collection("users").get()).forEach(u => {
        const d = u.data();
        usersData[u.id] = d.username || d.email || u.id;
      });

      // Fetch and sort tasks
      const taskSnap = await db.collection("tasks")
        .where("createdBy", "==", uid)
        .get();
      const tasks = [];
      taskSnap.forEach(doc => {
        const data = doc.data();
        tasks.push({ id: doc.id, ts: data.createdAt?.toMillis() || 0, data });
      });
      tasks.sort((a,b) => b.ts - a.ts);

      if (!tasks.length) {
        tasksContainer.innerHTML = "<p>No tasks posted.</p>";
        return;
      }

      for (const {id: taskId, data: task} of tasks) {
        // Task title
        const title = document.createElement("h2");
        title.className = "task-title";
        title.textContent = `${task.taskTitle} â€” ${task.category}`;
        tasksContainer.appendChild(title);

        // Create details sections for each status
        ['pending','approved','rejected'].forEach(status => {
          const details = document.createElement('details');
          const summary = document.createElement('summary');
          summary.textContent = status.charAt(0).toUpperCase() + status.slice(1);
          details.appendChild(summary);

          const table = document.createElement('table');
          table.className = 'sub-table';
          table.innerHTML = `
            <thead>
              <tr>
                <th>No.</th>
                <th>User</th>
                <th>Date</th>
                <th>Proof</th>
                <th>Image</th>
                <th>Approve</th>
                <th>Reject</th>
              </tr>
            </thead>
            <tbody id="${status}-tb-${taskId}"></tbody>`;
          details.appendChild(table);
          tasksContainer.appendChild(details);
        });

        // Listen submissions
        db.collection("task_submissions")
          .where("taskId","==",taskId)
          .onSnapshot(snap => {
            const subs = snap.docs.map(d => ({ id: d.id, data: d.data() }));
            // Sort newest-first
            subs.sort((a,b) => (b.data.submittedAt?.toMillis()||0) - (a.data.submittedAt?.toMillis()||0));
            // Group by status
            ['pending','approved','rejected'].forEach(status => {
              const tbody = document.getElementById(`${status}-tb-${taskId}`);
              tbody.innerHTML = '';
              const filtered = subs.filter(s => s.data.status === status);
              filtered.forEach((sub, idx) => {
                const d = sub.data;
                const tr = document.createElement('tr');
                const uname = usersData[d.userId] || d.userId;
                const dateStr = d.submittedAt?.toDate()?.toLocaleString() || '';
                tr.innerHTML = `
                  <td>${filtered.length - idx}</td>
                  <td>${uname}</td>
                  <td>${dateStr}</td>
                  <td>${d.textProof||''}</td>
                  <td></td>`;
                // Image cell
                const imgTd = document.createElement('td');
                if (d.imageProof) {
                  const btn = document.createElement('button');
                  btn.className = 'view-btn'; btn.textContent = 'View';
                  btn.onclick = () => window.open(d.imageProof, '_blank');
                  imgTd.appendChild(btn);
                }
                tr.replaceChild(imgTd, tr.children[4]);
                // Actions
                const apBtn = document.createElement('button');
                const rjBtn = document.createElement('button');
                apBtn.className = 'approve-btn'; apBtn.textContent = 'Approve';
                rjBtn.className = 'reject-btn';  rjBtn.textContent = 'Reject';
                if (d.status !== 'pending') {
                  [apBtn, rjBtn].forEach(b=>{b.disabled=true; b.style.opacity=0.5;});
                } else {
                  apBtn.onclick = async () => { await handleDecision(taskId, sub.id, true); };
                  rjBtn.onclick = async () => { await handleDecision(taskId, sub.id, false); };
                }
                const apTd = document.createElement('td'); apTd.appendChild(apBtn);
                const rjTd = document.createElement('td'); rjTd.appendChild(rjBtn);
                tr.appendChild(apTd); tr.appendChild(rjTd);
                tbody.appendChild(tr);
              });
            });
          });
      }
    }

    // Approve/Reject & credit at 70%
    async function handleDecision(taskId, subId, approve) {
      const subRef = db.collection("task_submissions").doc(subId);
      await subRef.update({ status: approve?"approved":"rejected" });
      if (approve) {
        const tdoc = await db.collection("tasks").doc(taskId).get();
        const t = tdoc.data();
        const reward = (t.costPerUser? t.costPerUser : (t.totalBudget/t.workersNeeded)) * 0.7;
        const s = await subRef.get();
        const uid = s.data().userId;
        await db.collection("users").doc(uid)
          .update({ balance: firebase.firestore.FieldValue.increment(reward) });
      }
    }
  </script></body>
</html>
