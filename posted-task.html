<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Tasks & Submissions</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --primary: #00b66d; --bg: #f7fdf8; --text: #333; --card-bg: #fff; --shadow: rgba(0,102,51,0.1); }
    * { box-sizing: border-box; margin:0; padding:0; }
    body { font-family:'Poppins',sans-serif; background:var(--bg); color:var(--text); padding-bottom:60px; }
    header { background:var(--primary); color:#fff; text-align:center; padding:1rem; font-size:1.5rem; box-shadow:0 4px 12px var(--shadow); }
    .note { text-align:center; font-size:0.9rem; color:var(--primary); margin:0.5rem 0; }
    .auth-card, .content { max-width:480px; margin:1rem auto; }
    .auth-card { background:var(--card-bg); padding:1.5rem; border-radius:12px; box-shadow:0 4px 12px var(--shadow); }
    .auth-card h2 { text-align:center; color:var(--primary); margin-bottom:1rem; }
    .auth-card input, .auth-card button { width:100%; padding:0.8rem; margin-bottom:1rem; border:1px solid #ddd; border-radius:8px; }
    .auth-card button { background:var(--primary); color:#fff; border:none; font-weight:600; cursor:pointer; }
    .auth-card p.error { color:#dc3545; text-align:center; }
    #dashboard { display:none; }
    #logoutBtn { display:block; margin:0 auto 1rem; background:#dc3545; color:#fff; padding:0.6rem 1rem; border:none; border-radius:8px; cursor:pointer; }
    .task-section { background:var(--card-bg); padding:1rem; margin-bottom:1.5rem; border-radius:12px; box-shadow:0 4px 12px var(--shadow); }
    .task-section h3 { margin-bottom:1rem; color:var(--primary); font-size:1.1rem; }
    details { margin-bottom:1rem; }
    summary { background: #e6f4e6; padding:0.6rem 1rem; border-radius:6px; cursor: pointer; display:flex; justify-content:space-between; align-items:center; }
    table { width:100%; border-collapse:collapse; margin-top:0.5rem; }
    th, td { padding:0.6rem; border-bottom:1px solid #eee; font-size:0.9rem; }
    th { background: #e6f4e6; }
    .btn { padding:0.4rem 0.8rem; border:none; border-radius:6px; color:#fff; cursor:pointer; font-size:0.8rem; }
    .approve { background:#28a745; }
    .reject { background:#dc3545; }
    .view { background:#0066cc; }
    .chart-container { max-width:480px; margin:1rem auto; background:var(--card-bg); padding:1rem; border-radius:12px; box-shadow:0 4px 12px var(--shadow); }
  </style>
</head>
<body>
  <header>My Tasks & Submissions</header>
  <p class="note">Payouts = 70% of task cost (decimals allowed)</p>  <div id="loginDiv" class="auth-card">
    <h2>Sign In</h2>
    <input id="email" type="email" placeholder="Email"/>
    <input id="password" type="password" placeholder="Password"/>
    <button id="loginBtn">Sign In</button>
    <p id="loginError" class="error"></p>
  </div>  <div id="dashboard">
    <button id="logoutBtn">Sign Out</button>
    <div id="tasksContainer" class="content"></div>
    <div class="chart-container">
      <canvas id="performanceChart"></canvas>
    </div>
  </div>  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>  <script>
    firebase.initializeApp({apiKey:"AIzaSyDRkip...",authDomain:"easypay-6bce8.firebaseapp.com",projectId:"easypay-6bce8"});
    const auth = firebase.auth(), db = firebase.firestore();
    const loginDiv = document.getElementById('loginDiv'), dashboard = document.getElementById('dashboard');
    const loginBtn = document.getElementById('loginBtn'), logoutBtn = document.getElementById('logoutBtn');
    const loginError = document.getElementById('loginError');
    loginBtn.onclick = ()=>{ loginError.textContent=''; auth.signInWithEmailAndPassword(email.value,password.value).catch(e=>loginError.textContent=e.message); };
    logoutBtn.onclick = ()=> auth.signOut();
    auth.onAuthStateChanged(user=>{ if(user){ loginDiv.style.display='none'; dashboard.style.display='block'; loadSubmissions(user.uid);} else{ dashboard.style.display='none'; loginDiv.style.display='block'; }});

    async function loadSubmissions(uid){
      const tasksSnap = await db.collection('tasks').where('createdBy','==',uid).get();
      const tasks = tasksSnap.docs.map(d=>({id:d.id,data:d.data()}));
      const submissions = await db.collection('task_submissions').get();
      const counts = {};
      tasks.forEach(t=>counts[t.id]=0);
      submissions.docs.forEach(s=>{ const d=s.data(); if(d.status==='approved'&&counts[d.taskId]!=null) counts[d.taskId]++; });

      const container = document.getElementById('tasksContainer'); container.innerHTML='';
      tasks.forEach(({id, data})=>{
        const section = document.createElement('div'); section.className='task-section';
        section.innerHTML = `<h3>${data.taskTitle} â€” ${data.category}</h3>`;
        ['pending','approved','rejected'].forEach(status=>{
          const det = document.createElement('details');
          const sum = document.createElement('summary'); sum.textContent = status.charAt(0).toUpperCase()+status.slice(1);
          det.appendChild(sum);
          const tbl = document.createElement('table');
          tbl.innerHTML = `<thead><tr><th>No</th><th>User</th><th>Date</th><th>Proof</th><th>Img</th><th>Actions</th></tr></thead><tbody id="${status}-tb-${id}"></tbody>`;
          det.appendChild(tbl);
          section.appendChild(det);

          db.collection('task_submissions').where('taskId','==',id).where('status','==',status)
            .onSnapshot(snap=>{
              const rows = snap.docs.map(d=>d.data());
              const tb = document.getElementById(`${status}-tb-${id}`);
              tb.innerHTML='';
              rows.forEach((d,i)=>{
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${rows.length-i}</td><td>${d.username}</td><td>${d.submittedAt?.toDate()?.toLocaleString()||''}</td><td>${d.textProof||''}</td><td></td><td></td>`;
                const imgTd = document.createElement('td');
                if(d.imageProof){ const btn=document.createElement('button'); btn.className='view'; btn.textContent='View'; btn.onclick=()=>window.open(d.imageProof,'_blank'); imgTd.appendChild(btn); }
                tr.replaceChild(imgTd,tr.cells[4]);
                const actTd = document.createElement('td');
                if(d.status==='pending'){
                  const ap=document.createElement('button'), rj=document.createElement('button');
                  ap.className='approve'; ap.textContent='Approve'; ap.onclick=()=>decide(id,d.userId,true);
                  rj.className='reject'; rj.textContent='Reject'; rj.onclick=()=>decide(id,d.userId,false);
                  actTd.appendChild(ap); actTd.appendChild(rj);
                }
                tr.appendChild(actTd);
                tb.appendChild(tr);
              });
            });
        });
        container.appendChild(section);
      });
      renderChart(tasks, counts);
    }
    async function decide(taskId, userId, ok){
      const subs = await db.collection('task_submissions').where('taskId','==',taskId).where('userId','==',userId).get();
      const docId = subs.docs[0].id;
      await db.collection('task_submissions').doc(docId).update({status: ok?'approved':'rejected'});
      if(ok){ const task = (await db.collection('tasks').doc(taskId).get()).data();
        const reward = ((task.costPerUser)||(task.totalBudget/task.workersNeeded))*0.7;
        await db.collection('users').doc(userId).update({balance:firebase.firestore.FieldValue.increment(reward)});
      }
    }
    function renderChart(tasks, counts){
      const ctx = document.getElementById('performanceChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar', data: {
          labels: tasks.map(t=>t.data.taskTitle),
          datasets: [{ label: 'Approved Submissions', data: tasks.map(t=>counts[t.id]), backgroundColor: 'rgba(0,182,109,0.6)' }]
        }, options: {
          responsive: true, scales: { y: { beginAtZero: true } }
        }
      });
    }
  </script></body>
</html>
