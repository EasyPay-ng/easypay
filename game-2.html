<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Avoid the Bomb ‚Äì EasyPay</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --green: #2e7d32;
      --red: #d32f2f;
      --bg: #f0fff0;
    }
    body {
      margin: 0;
      background: var(--bg);
      font-family: 'Poppins', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
    }
    h1 {
      color: var(--green);
    }
    #gameArea {
      position: relative;
      width: 300px;
      height: 400px;
      background: white;
      border: 2px solid var(--green);
      overflow: hidden;
      margin-top: 15px;
      border-radius: 10px;
    }
    #player {
      position: absolute;
      width: 40px;
      height: 40px;
      bottom: 10px;
      background: var(--green);
      border-radius: 8px;
    }
    .bomb {
      position: absolute;
      width: 30px;
      height: 30px;
      background: var(--red);
      top: 0;
      border-radius: 50%;
      animation: fall 3s linear infinite;
    }
    @keyframes fall {
      to { top: 400px; }
    }
    #status {
      margin-top: 15px;
      font-weight: bold;
    }
  </style>
</head>
<body>

<h1>üí£ Avoid the Bomb</h1>
<p>Survive 30 seconds to earn ‚Ç¶20</p>
<div id="status">Time left: 30s</div>
<div id="gameArea">
  <div id="player"></div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
  // Firebase Setup
  const firebaseConfig = {
    apiKey: "AIzaSyDRkip46Ql5KhNfuatWAcAxQzgP5VtQ8UY",
    authDomain: "easypay-6bce8.firebaseapp.com",
    projectId: "easypay-6bce8"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let user, timer, timeLeft = 30, gameRunning = true;
  let gameArea, player;

  auth.onAuthStateChanged(async (u) => {
    if (!u) return location.href = "login.html";
    user = u;
    const doc = await db.collection("users").doc(user.uid).get();
    const last = doc.data()?.lastAvoidTheBomb;
    if (last && Date.now() - last < 86400000) {
      document.body.innerHTML = "<h2 style='color:red;'>‚è≥ You can only play this game once every 24 hours.</h2>";
    } else {
      startGame();
    }
  });

  function startGame() {
    gameArea = document.getElementById("gameArea");
    player = document.getElementById("player");
    let pos = 130;
    player.style.left = pos + "px";

    // Move control
    document.addEventListener("keydown", e => {
      if (!gameRunning) return;
      if (e.key === "ArrowLeft" && pos > 0) pos -= 20;
      if (e.key === "ArrowRight" && pos < 260) pos += 20;
      player.style.left = pos + "px";
    });

    // Touch control
    gameArea.addEventListener("touchstart", e => {
      if (!gameRunning) return;
      const x = e.touches[0].clientX - gameArea.getBoundingClientRect().left;
      pos = Math.max(0, Math.min(260, x - 20));
      player.style.left = pos + "px";
    });

    timer = setInterval(() => {
      timeLeft--;
      document.getElementById("status").innerText = `Time left: ${timeLeft}s`;
      if (timeLeft === 0) {
        clearInterval(timer);
        winGame();
      }
    }, 1000);

    spawnBombs();
  }

  function spawnBombs() {
    const drop = setInterval(() => {
      if (!gameRunning) return clearInterval(drop);
      const bomb = document.createElement("div");
      bomb.classList.add("bomb");
      bomb.style.left = Math.floor(Math.random() * 270) + "px";
      gameArea.appendChild(bomb);

      let y = 0;
      const fall = setInterval(() => {
        if (!gameRunning) return clearInterval(fall);
        y += 4;
        bomb.style.top = y + "px";
        const bombRect = bomb.getBoundingClientRect();
        const playerRect = player.getBoundingClientRect();
        if (checkCollision(bombRect, playerRect)) {
          clearInterval(timer);
          gameRunning = false;
          document.getElementById("status").innerHTML = "<span style='color:red;'>üí• You were hit! Try again tomorrow.</span>";
          db.collection("users").doc(user.uid).update({ lastAvoidTheBomb: Date.now() });
        }
        if (y > 400) {
          clearInterval(fall);
          bomb.remove();
        }
      }, 20);
    }, 800);
  }

  function checkCollision(r1, r2) {
    return !(
      r1.bottom < r2.top ||
      r1.top > r2.bottom ||
      r1.right < r2.left ||
      r1.left > r2.right
    );
  }

  async function winGame() {
    gameRunning = false;
    document.getElementById("status").innerHTML = "<span style='color:green;'>‚úÖ You survived! ‚Ç¶20 credited.</span>";
    await db.collection("users").doc(user.uid).update({
      lastAvoidTheBomb: Date.now()
    });
    const userRef = db.collection("users").doc(user.uid);
    const userDoc = await userRef.get();
    const newBal = (userDoc.data().balance || 0) + 20;
    await userRef.update({ balance: newBal });
    await db.collection("users").doc(user.uid).collection("transactions").add({
      source: "Avoid the Bomb",
      amount: 20,
      date: new Date().toISOString()
    });
  }
</script>

</body>
</html>
