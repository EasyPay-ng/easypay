<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin — Manage Withdrawals</title>
  <style>
    body { font-family: 'Poppins', sans-serif; background-color: #f0fff0; color: #222; padding: 20px; }
    h2 { color: #2e7d32; margin-bottom: 10px; }
    #totalAmount { background: #e8f5e9; color: #1b5e20; padding: 10px; font-weight: bold; border-radius: 6px; display: inline-block; margin-bottom: 15px; }
    table { width: 100%; border-collapse: collapse; background-color: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    th, td { padding: 12px; border-bottom: 1px solid #ddd; }
    th { background-color: #d0f0d0; font-weight: 600; text-align: left; }
    select { padding: 6px 10px; border-radius: 4px; border: 1px solid #ccc; }
    tr:hover { background-color: #f4fff4; }
    .error { color:#b91c1c; font-weight:600; }
    .muted { color:#666; }
    #actions { margin: 0 0 12px; }
    #reloadBtn { padding:8px 12px; border:1px solid #cfd8cf; background:#fff; border-radius:8px; cursor:pointer; }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collectionGroup, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    // 🔐 Use the same config you use on your working pages
    const firebaseConfig = {
      apiKey: "AIzaSyDRkip46Ql5KhNfuatWAcAxQzgP5VtQ8UY",
      authDomain: "easypay-6bce8.firebaseapp.com",
      projectId: "easypay-6bce8",
      storageBucket: "easypay-6bce8.firebasestorage.app",
      messagingSenderId: "862671358267",
      appId: "1:862671358267:web:b243c7b69840ef918c8f1e", // ← match your other pages
      measurementId: "G-2FZKDQ47FZ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ---------- Utilities ----------
    const fmtNGN = new Intl.NumberFormat('en-NG', {
      style: 'currency', currency: 'NGN', minimumFractionDigits: 2
    });

    function safeNumber(v) {
      const n = typeof v === 'number' ? v : Number(v);
      return Number.isFinite(n) ? n : 0;
    }

    function tsToMillis(ts) {
      if (!ts) return null;
      // Firestore Timestamp object
      if (typeof ts.toMillis === 'function') return ts.toMillis();
      if (typeof ts.toDate === 'function') return ts.toDate().getTime();
      // Plain {seconds, nanoseconds}
      if (typeof ts.seconds === 'number') {
        const ns = typeof ts.nanoseconds === 'number' ? ts.nanoseconds : 0;
        return ts.seconds * 1000 + Math.floor(ns / 1e6);
      }
      // Already ms or number
      if (typeof ts === 'number') return ts;
      // ISO/date string
      const d = new Date(ts);
      return isNaN(d) ? null : d.getTime();
    }

    function statusPriority(s) {
      if (s === 'Pending' || !s) return 0;
      if (s === 'Successful') return 1;
      if (s === 'Rejected') return 2;
      return 3;
    }

    function sortWithdrawals(arr) {
      return arr.sort((a, b) => {
        const pA = statusPriority(a.data?.status);
        const pB = statusPriority(b.data?.status);
        if (pA !== pB) return pA - pB;

        const tA = tsToMillis(a.data?.timestamp || a.data?.date) ?? 0;
        const tB = tsToMillis(b.data?.timestamp || b.data?.date) ?? 0;
        return tB - tA; // newest first
      });
    }

    // ---------- DOM ----------
    const tbody = document.querySelector('#withdrawalTable tbody');
    const totalAmountEl = document.getElementById('totalAmount');
    const reloadBtn = document.getElementById('reloadBtn');

    function setLoading() {
      tbody.innerHTML = `<tr><td class="muted" colspan="7">Loading…</td></tr>`;
    }

    function setEmpty(message = 'No withdrawal requests found.') {
      tbody.innerHTML = `<tr><td class="muted" colspan="7">${message}</td></tr>`;
    }

    function setError(err) {
      const msg = err?.message || err?.code || String(err) || 'Unknown error';
      tbody.innerHTML = `<tr><td class="error" colspan="7">Error: ${msg}</td></tr>`;
    }

    function getUsernameFromPath(path) {
      // Expected path "users/{uid}/withdrawals/{docId}" → uid is index 1
      const parts = (path || '').split('/');
      return parts[1] || '—';
    }

    function renderRows(items) {
      tbody.innerHTML = '';
      for (const item of items) {
        const d = item.data || {};
        const dateMs = tsToMillis(d.timestamp || d.date);
        const dateStr = dateMs ? new Date(dateMs).toLocaleString() : '—';
        const amount = safeNumber(d.amount);
        const netAmt = amount * 0.95;
        const bank = d.bank || '—';
        const accNumber = d.accNumber || '—';
        const accName = d.accName || '—';
        const username = d.username || item.username || '—';
        const status = d.status || 'Pending';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${dateStr}</td>
          <td>${fmtNGN.format(netAmt)}</td>
          <td>${bank}</td>
          <td>${accNumber}</td>
          <td>${accName}</td>
          <td>${username}</td>
          <td>
            <select data-path="${item.path}" class="statusSelect">
              ${['Pending','Successful','Rejected'].map(s => `<option value="${s}" ${status===s?'selected':''}>${s}</option>`).join('')}
            </select>
          </td>
        `;
        tbody.appendChild(tr);
      }

      // Attach status update listeners
      tbody.querySelectorAll('select.statusSelect').forEach(sel => {
        sel.addEventListener('change', async (e) => {
          const el = e.currentTarget;
          const newStatus = el.value;
          el.disabled = true;
          try {
            const refDoc = doc(db, el.getAttribute('data-path'));
            await updateDoc(refDoc, { status: newStatus });
            alert('Status updated to ' + newStatus);
            await loadWithdrawals();
          } catch (err) {
            console.error(err);
            alert('Failed to update status: ' + (err?.message || err));
          } finally {
            el.disabled = false;
          }
        });
      });
    }

    async function loadWithdrawals() {
      setLoading();
      try {
        const snapshot = await getDocs(collectionGroup(db, "withdrawals"));

        if (snapshot.empty) {
          totalAmountEl.textContent = `Total Net Withdrawn: ${fmtNGN.format(0)}`;
          setEmpty('No withdrawal requests found.');
          return;
        }

        const allDocs = [];
        let totalNet = 0;

        snapshot.forEach(docSnap => {
          const data = docSnap.data() || {};
          const amount = safeNumber(data.amount);
          if (amount > 0) totalNet += amount * 0.95;

          // Use stored username if provided, otherwise fallback to uid in path
          const fallbackUsername = getUsernameFromPath(docSnap.ref.path);
          allDocs.push({
            path: docSnap.ref.path,
            data,
            username: data.username || fallbackUsername
          });
        });

        const sorted = sortWithdrawals(allDocs);
        totalAmountEl.textContent = `Total Net Withdrawn: ${fmtNGN.format(totalNet)}`;
        renderRows(sorted);
      } catch (err) {
        console.error(err);
        setError(err);
      }
    }

    // Show unhandled promise errors in the table instead of failing silently
    window.addEventListener('unhandledrejection', (e) => {
      console.error('Unhandled promise rejection:', e.reason);
      setError(e.reason || 'Unhandled promise rejection');
    });

    // Reload button
    reloadBtn?.addEventListener('click', loadWithdrawals);

    // Initial load
    loadWithdrawals();
  </script>
</head>
<body>
  <h2>Admin Withdrawal Records</h2>
  <div id="actions">
    <button id="reloadBtn">Reload</button>
  </div>
  <div id="totalAmount">Loading total...</div>

  <table id="withdrawalTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Net Amount (₦ after 5% fee)</th>
        <th>Bank</th>
        <th>Account Number</th>
        <th>Account Name</th>
        <th>Username</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="7" class="muted">Loading…</td></tr>
    </tbody>
  </table>
</body>
</html>
