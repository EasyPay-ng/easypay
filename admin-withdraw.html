<!DOCTYPE html><html lang="en"><head>  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin — Manage Withdrawals</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collectionGroup, getDocs, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDRkip46Ql5KhNfuatWAcAxQzgP5VtQ8UY",
  authDomain: "easypay-6bce8.firebaseapp.com",
  projectId: "easypay-6bce8",
  storageBucket: "easypay-6bce8.firebasestorage.app",
  messagingSenderId: "862671358267",
  appId: "1:862671358267:web:b243c7b69840ef918c1e",
  measurementId: "G-2FZKDQ47FZ"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Sort withdrawals (Pending first, then by date)
function sortWithdrawals(arr) {
  return arr.sort((a, b) => {
    const statusA = a.data.status;
    const statusB = b.data.status;
    if (statusA === "Pending" && statusB !== "Pending") return -1;
    if (statusA !== "Pending" && statusB === "Pending") return 1;
    const tsA = a.data.timestamp?.seconds || 0;
    const tsB = b.data.timestamp?.seconds || 0;
    return tsB - tsA;
  });
}

async function loadWithdrawals() {
  const withdrawalQuery = collectionGroup(db, "withdrawals");
  const snapshot = await getDocs(withdrawalQuery);

  const allDocs = [];
  let totalNet = 0;
  const userPathsSet = new Set(); // to collect which user docs we need to fetch

  // First pass: collect withdrawal info (no awaiting inside loop)
  snapshot.forEach(docSnap => {
    const data = docSnap.data();

    // Only add Successful withdrawals to total
    if (typeof data.amount === "number" && data.status === "Successful") {
      const net = data.amount * 0.95;
      totalNet += net;
    }

    const parts = docSnap.ref.path.split("/");
    // uid is the parent document id (usually the user uid)
    const uid = data.uid || (parts.length >= 2 ? parts[1] : null);
    const shortUid = uid ? uid.toString().slice(0,5) : 'N/A';

    // plan may exist on withdrawal doc; if not, we'll fetch from the parent user doc later
    const planFromWithdrawal = data.plan || null;
    const userPath = parts.length >= 2 ? `${parts[0]}/${parts[1]}` : null;
    if (!planFromWithdrawal && userPath) userPathsSet.add(userPath);

    allDocs.push({
      path: docSnap.ref.path,
      data,
      uid,
      shortUid,
      plan: planFromWithdrawal, // can be null for now
      userPath
    });
  });

  // Fetch user documents for any users that didn't have plan set on withdrawal
  const userPaths = Array.from(userPathsSet);
  const userFetchPromises = userPaths.map(p => {
    const [col, id] = p.split("/");
    return getDoc(doc(db, col, id)).then(snap => ({ path: p, snap }));
  });

  const userResults = await Promise.all(userFetchPromises);
  const userPlanMap = {};
  userResults.forEach(({ path, snap }) => {
    userPlanMap[path] = (snap && snap.exists()) ? (snap.data().plan || 'N/A') : 'N/A';
  });

  // Fill missing plans from fetched user docs
  allDocs.forEach(item => {
    if (!item.plan) {
      item.plan = item.userPath && userPlanMap[item.userPath] ? userPlanMap[item.userPath] : 'N/A';
    }
  });

  const sorted = sortWithdrawals(allDocs);
  document.getElementById("totalAmount").textContent = 
    `Total Net Withdrawn: ₦${totalNet.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}`;

  const tbody = document.getElementById("withdrawalTable").querySelector("tbody");
  tbody.innerHTML = "";

  sorted.forEach(item => {
    const d = item.data;
    const dateStr = d.timestamp?.seconds 
      ? new Date(d.timestamp.seconds * 1000).toLocaleString() 
      : "N/A";
    const netAmt = (d.amount * 0.95).toFixed(2);

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${dateStr}</td>
      <td>₦${netAmt}</td>
      <td>${d.bank || 'N/A'}</td>
      <td>${d.accNumber || 'N/A'}</td>
      <td>${d.accName || 'N/A'}</td>
      <td>${item.plan || 'N/A'}</td>
      <td>${item.shortUid}</td>
      <td>
        <select data-path="${item.path}" onchange="updateStatus(this)">
          <option value="Pending" ${d.status === "Pending" ? "selected" : ""}>Pending</option>
          <option value="Successful" ${d.status === "Successful" ? "selected" : ""}>Successful</option>
          <option value="Rejected" ${d.status === "Rejected" ? "selected" : ""}>Rejected</option>
        </select>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// Use doc(db, ...path.split("/")) for doc reference
window.updateStatus = async function(selectEl) {
  const path = selectEl.getAttribute("data-path");
  const newStatus = selectEl.value;
  const refDoc = doc(db, ...path.split("/"));  
  await updateDoc(refDoc, { status: newStatus });
  alert("Status updated to " + newStatus);
  loadWithdrawals();
};

loadWithdrawals();

  </script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f0fff0;
      color: #222;
      padding: 20px;
    }
    h2 {
      color: #2e7d32;
      margin-bottom: 10px;
    }
    #totalAmount {
      background: #e8f5e9;
      color: #1b5e20;
      padding: 10px;
      font-weight: bold;
      border-radius: 6px;
      display: inline-block;
      margin-bottom: 15px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #fff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    th, td {
      padding: 12px;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #d0f0d0;
      font-weight: 600;
    }
    select {
      padding: 6px 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    tr:hover {
      background-color: #f4fff4;
    }
  </style>
</head>
<body>
  <h2>Admin Withdrawal Records</h2>
  <div id="totalAmount">Loading total...</div>
  <table id="withdrawalTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Net Amount (₦ after 5% fee)</th>
        <th>Bank</th>
        <th>Account Number</th>
        <th>Account Name</th>
        <th>Plan</th>
        <th>UID (first 5)</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="8">Loading…</td></tr>
    </tbody>
  </table>
</body>
</html>
