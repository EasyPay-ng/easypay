<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EasyPay PTC Task #1</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4fdf7;
      color: #333;
      margin: 0; padding: 0;
    }
    header {
      background-color: #0f9d58;
      color: #fff;
      padding: 1rem;
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
      position: relative;
    }
    .timer {
      position: absolute;
      top: 50%;
      right: 1rem;
      transform: translateY(-50%);
      font-size: 1.25rem;
      background: rgba(255,255,255,0.2);
      padding: 0.25rem 0.75rem;
      border-radius: 6px;
    }
    .notice {
      background: #e6fff0;
      border-left: 4px solid #0f9d58;
      padding: 1rem;
      margin: 1rem;
      border-radius: 8px;
      font-size: 0.95rem;
    }
    .content {
      max-width: 800px;
      margin: 1.5rem auto;
      text-align: center;
    }
    iframe, .fallback {
      width: 100%;
      height: 450px;
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .fallback {
      display: none;
      padding: 1rem;
      background: #fff;
      text-align: left;
    }
  </style>
</head>
<body>

  <header>
    EasyPay PTC Task #1
    <div class="timer" id="timer">20s</div>
  </header>

  <div class="notice">
    <strong>Important!</strong> JS & cookies enabled, ad-block off, no VPN, stay here for 20 seconds.
  </div>

  <div class="content">
    <iframe id="randomContent" src="" allowfullscreen></iframe>
    <div class="fallback" id="fallback">
      <p>Unable to load content. Check your API key or network.</p>
    </div>
  </div>

  <!-- Firebase + (optional) Google Custom Search libraries -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore.js";

    // â”€â”€â”€ Firebase config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const firebaseConfig = {
      apiKey: "AIzaSyDRkip46Ql5KhNfuatWAcAxQzgP5VtQ8UY",
      authDomain: "easypay-6bce8.firebaseapp.com",
      projectId: "easypay-6bce8",
      storageBucket: "easypay-6bce8.firebasestorage.app",
      messagingSenderId: "862671358267",
      appId: "1:862671358267:web:b243c7b69840ef918c8f1e",
      measurementId: "G-2FZKDQ47FZ"
    };
    const app   = initializeApp(firebaseConfig);
    const auth  = getAuth(app);
    const db    = getFirestore(app);

    // â”€â”€â”€ Task / reward config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const PTC_ID    = "ptc1";                           // update for each page
    const LAST_KEY  = `lastClaim_${PTC_ID}`;
    const BAL_KEY   = "balance";
    const REWARD    = 1;
    const COOLDOWN  = 24 * 60 * 60 * 1000;              // 24 hrs in ms

    let userDocRef = null;
    onAuthStateChanged(auth, user => {
      if (!user) {
        alert("Please log in to claim rewards.");
      } else {
        userDocRef = doc(db, "users", user.uid);
      }
    });

    // â”€â”€â”€ (Optional) Google Custom Search to load dynamic content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ...or simply point iframe.src to a static URL if you prefer.
    const GOOGLE_API_KEY = "YOUR_GOOGLE_API_KEY";
    const CSE_ID         = "YOUR_CSE_ID";
    async function loadRandomContent() {
      try {
        const res = await fetch(
          `https://www.googleapis.com/customsearch/v1?key=${GOOGLE_API_KEY}` +
          `&cx=${CSE_ID}&q=blog+OR+video&num=10`
        );
        const data = await res.json();
        const items = data.items || [];
        if (!items.length) throw new Error("No results");
        const link = items[Math.floor(Math.random()*items.length)].link;
        // embed YouTube if appropriate
        if (/youtube\.com\/watch\?v=/.test(link)) {
          const vid = new URL(link).searchParams.get("v");
          document.getElementById("randomContent").src =
            `https://www.youtube.com/embed/${vid}?autoplay=1`;
        } else {
          document.getElementById("randomContent").src = link;
        }
      } catch (err) {
        console.error(err);
        document.getElementById("randomContent").style.display = "none";
        document.getElementById("fallback").style.display      = "block";
      }
    }
    loadRandomContent();

    // â”€â”€â”€ 20s countdown & auto-claim â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let seconds = 20;
    const timerEl = document.getElementById("timer");

    const countdown = setInterval(async () => {
      if (seconds > 0) {
        timerEl.textContent = `${--seconds}s`;
      } else {
        clearInterval(countdown);
        timerEl.textContent = "0s";
        await autoClaimReward();
      }
    }, 1000);

    // â”€â”€â”€ Auto-claim function â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function autoClaimReward() {
      if (!userDocRef) return;
      const now = Date.now();
      const snap = await getDoc(userDocRef);
      let last = 0, bal = 0;
      if (snap.exists()) {
        const data = snap.data();
        last = data[LAST_KEY] || 0;
        bal  = data[BAL_KEY]  || 0;
      }
      if (now - last < COOLDOWN) {
        alert("Youâ€™ve already claimed this task in the last 24 hours.");
        return;
      }
      const updates = { [LAST_KEY]: now, [BAL_KEY]: bal + REWARD };
      snap.exists() ? await updateDoc(userDocRef, updates)
                    : await setDoc(userDocRef, updates);
      alert(`ðŸŽ‰ Success! â‚¦${REWARD} credited to your account.`);
    }
  </script>
</body>
</html>
