<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EasyPay — Withdraw</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
  <style>
    :root{
      --primary:#00b66d;
      --bg:#f7fdf8;
      --card:#ffffff;
      --muted:#6b7280;
      --shadow: 0 8px 24px rgba(16,24,40,0.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:'Poppins',system-ui,Segoe UI,Roboto,Helvetica,Arial;
      background:var(--bg); color:#0f1720; -webkit-font-smoothing:antialiased;
    }
    .wrap { max-width:980px; margin:20px auto; padding:18px; }

    .notice {
      background:#fffbea; border:1px solid #fff2c2; color:#6b4a00; padding:12px 14px;
      border-radius:10px; display:flex; justify-content:space-between; align-items:center; gap:12px;
      box-shadow:var(--shadow); margin-bottom:16px;
    }
    .grid { display:grid; grid-template-columns: 1fr 420px; gap:16px; align-items:start; }
    @media (max-width:980px){ .grid{ grid-template-columns: 1fr; } }

    .card {
      background:var(--card); border-radius:12px; padding:14px; box-shadow:var(--shadow);
    }

    .form h2 { color:var(--primary); margin:0 0 12px; font-size:18px; }
    .field { margin-bottom:10px; display:flex; flex-direction:column; gap:6px; }
    label{ font-size:13px; color:var(--muted); }
    input, select { padding:10px 12px; border-radius:8px; border:1px solid #e6efe8; font-size:14px; background:#fcfff9; }
    .row { display:flex; gap:8px; }
    .row .col{ flex:1; }
    .actions { display:flex; gap:10px; align-items:center; margin-top:10px; }

    button.primary {
      background:var(--primary); color:#fff; border:0; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer;
      display:inline-flex; gap:8px; align-items:center;
    }
    button.ghost { background:#fff; border:1px solid #e6f6ea; color:var(--primary); padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700; }
    button:disabled { opacity:0.7; cursor:not-allowed; }

    .hint { color:var(--muted); font-size:13px; margin-top:6px; }
    .error { color:#b91c1c; font-size:13px; margin-top:6px; display:none; }

    /* table */
    .tableWrap { overflow:auto; }
    table { width:100%; border-collapse:collapse; min-width:560px; }
    th, td { padding:10px 12px; text-align:left; border-bottom:1px solid #f2f7f2; font-size:14px; }
    thead th { background:var(--primary); color:#fff; position:sticky; top:0; z-index:1; font-weight:600; font-size:13px; }
    .status { padding:6px 8px; border-radius:6px; color:#fff; font-weight:700; display:inline-block; font-size:13px; }
    .status-pending { background:#fd7e14; }
    .status-approved { background:#28a745; }
    .status-rejected { background:#dc3545; }

    .small-muted{ font-size:13px; color:var(--muted); }
    .spinner { width:16px; height:16px; border:2px solid #fff; border-top-color:transparent; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to{ transform:rotate(360deg); } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="notice">
      <div>Withdrawals normally take up to 48 hours. Please allow processing time.</div>
      <div><a href="contact.html" style="color:var(--primary); font-weight:700; text-decoration:none">Contact Support</a></div>
    </div>

    <div class="grid">
      <!-- left: form & table -->
      <div class="card form">
        <h2>Request Withdrawal</h2>

        <div id="eligibilityNote" class="hint" style="display:none;"></div>

        <div class="field">
          <label for="amount">Amount (₦150 – ₦300)</label>
          <input id="amount" type="number" inputmode="numeric" min="150" max="300" placeholder="Enter amount" />
          <div class="error" id="amountError">Amount must be between ₦150 and ₦300.</div>
        </div>

        <div class="row">
          <div class="col field">
            <label for="bank">Bank</label>
            <select id="bank">
              <option value="">-- Choose bank --</option>
              <option>Access Bank</option><option>Kuda</option><option>PalmPay</option>
              <option>Moniepoint</option><option>Opay</option><option>GTBank</option>
              <option>First Bank</option><option>UBA</option><option>Zenith Bank</option>
              <option>Wema Bank</option><option>SmartCash PSB</option><option>Momo PSB</option>
            </select>
          </div>
          <div class="col field">
            <label for="accNumber">Account number</label>
            <input id="accNumber" type="text" inputmode="numeric" maxlength="15" placeholder="0123456789" />
          </div>
        </div>

        <div class="field">
          <label for="accName">Account name</label>
          <input id="accName" type="text" placeholder="Recipient name" />
        </div>

        <div class="actions">
          <button id="submitBtn" class="primary">Submit Withdrawal</button>
          <button id="clearBtn" class="ghost" type="button">Clear</button>
          <div id="formHint" class="small-muted" aria-live="polite"></div>
        </div>
      </div>

      <!-- right: quick-stats & history -->
      <div>
        <div class="card" style="margin-bottom:12px;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <div class="small-muted">Main Balance</div>
              <div style="font-size:20px; font-weight:800; color:var(--primary)">₦<span id="balance">0.00</span></div>
            </div>
            <div style="text-align:right">
              <div class="small-muted">Plan</div>
              <div style="font-weight:800" id="planLabel">—</div>
            </div>
          </div>
          <div class="hint" style="margin-top:10px">Minimum ₦150 — Maximum ₦300 per withdrawal.</div>
        </div>

        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <div style="font-weight:700">Recent Withdrawals</div>
            <div class="small-muted"><a href="history.html" style="color:var(--primary); text-decoration:none">See all</a></div>
          </div>
          <div class="tableWrap" style="max-height:260px; overflow:auto">
            <table>
              <thead>
                <tr><th>Date</th><th>Amt</th><th>Bank</th><th>Acct</th><th>Status</th></tr>
              </thead>
              <tbody id="withdrawalsTbody">
                <tr><td colspan="5" style="padding:12px; color:var(--muted)">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // Firebase modular SDK imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore, doc, collection, query, orderBy, limit, onSnapshot,
      runTransaction, serverTimestamp, getDoc
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // YOUR FIREBASE CONFIG (unchanged)
    const firebaseConfig = {
      apiKey: "AIzaSyDRkip46Ql5KhNfuatWAcAxQzgP5VtQ8UY",
      authDomain: "easypay-6bce8.firebaseapp.com",
      projectId: "easypay-6bce8",
      storageBucket: "easypay-6bce8.firebasestorage.app",
      messagingSenderId: "862671358267",
      appId: "1:862671358267:web:b243c7b69840ef918c8f1e",
      measurementId: "G-2FZKDQ47FZ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI refs
    const amountInput = document.getElementById('amount');
    const bankInput = document.getElementById('bank');
    const accNumberInput = document.getElementById('accNumber');
    const accNameInput = document.getElementById('accName');
    const submitBtn = document.getElementById('submitBtn');
    const clearBtn = document.getElementById('clearBtn');
    const amountError = document.getElementById('amountError');
    const formHint = document.getElementById('formHint');
    const eligibilityNote = document.getElementById('eligibilityNote');

    const balanceEl = document.getElementById('balance');
    const planLabel = document.getElementById('planLabel');
    const withdrawalsTbody = document.getElementById('withdrawalsTbody');

    let currentUid = null;
    let userDocRef = null;
    let unsubWithdrawals = null;
    let currentUserData = null;
    let eligible = false;

    const MIN = 150;
    const MAX = 300;

    function showError(msg){
      amountError.textContent = msg;
      amountError.style.display = 'block';
    }
    function hideError(){
      amountError.style.display = 'none';
    }

    // Auth state listener
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        alert('Please sign in.');
        return location.href = 'login.html';
      }
      currentUid = user.uid;
      userDocRef = doc(db, 'users', currentUid);

      // subscribe to user doc for realtime updates
      const snap = await getDoc(userDocRef);
      if (!snap.exists()) {
        alert('User record not found.');
        return location.href = 'login.html';
      }
      currentUserData = snap.data();
      // initial UI fill
      updateUserUI(currentUserData);

      // realtime listener for user doc to keep balance & plan live
      // (use onSnapshot if you want continuous updates; here we use onSnapshot for live)
      // Keep a simple onSnapshot to update balances and plan.
      const userUnsub = onSnapshot(userDocRef, s => {
        if (!s.exists()) return;
        currentUserData = s.data();
        updateUserUI(currentUserData);
      });

      // subscribe to recent withdrawals (user subcollection)
      subscribeWithdrawals();
    });

    function updateUserUI(data){
      const bal = Number(data.balance || 0);
      balanceEl.textContent = bal.toLocaleString();
      const plan = (data.plan || '').toString();
      planLabel.textContent = plan ? capitalize(plan) : '—';
      // eligibility: only premium or gold
      eligible = ['premium','gold'].includes(plan.toLowerCase());
      if (!eligible) {
        submitBtn.disabled = true;
        eligibilityNote.style.display = 'block';
        eligibilityNote.textContent = 'Withdrawals are available to Premium and Gold users only. Visit upgrade.html to upgrade.';
        formHint.textContent = 'Upgrade required to withdraw';
      } else {
        submitBtn.disabled = false;
        eligibilityNote.style.display = 'none';
        formHint.textContent = '';
      }
    }

    function capitalize(s){ if (!s) return ''; return s.charAt(0).toUpperCase()+s.slice(1); }

    // Subscribe to latest 20 withdrawals for this user
    function subscribeWithdrawals(){
      if (unsubWithdrawals) unsubWithdrawals();
      const wCol = collection(userDocRef, 'withdrawals');
      const q = query(wCol, orderBy('requestedAt', 'desc'), limit(20));
      unsubWithdrawals = onSnapshot(q, snap => {
        if (snap.empty) {
          withdrawalsTbody.innerHTML = '<tr><td colspan="5" style="padding:12px; color:var(--muted)">No withdrawals yet.</td></tr>';
          return;
        }
        let html = '';
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const ts = d.requestedAt;
          let dateStr = '—';
          if (ts && typeof ts.toDate === 'function') dateStr = ts.toDate().toLocaleString();
          else if (ts && ts.seconds) dateStr = new Date(ts.seconds * 1000).toLocaleString();
          const amt = Number(d.amount || 0).toLocaleString();
          const bank = d.bank || '';
          const acc = d.accNumber || d.accNum || '';
          const status = (d.status || 'pending').toLowerCase();
          const cls = status === 'approved' ? 'status-approved' : status === 'rejected' ? 'status-rejected' : 'status-pending';
          const icon = status === 'approved' ? '✅' : status === 'rejected' ? '❌' : '⏳';
          const statusText = status.charAt(0).toUpperCase() + status.slice(1);
          html += `<tr>
            <td>${escapeHtml(dateStr)}</td>
            <td>₦${escapeHtml(amt)}</td>
            <td>${escapeHtml(bank)}</td>
            <td>${escapeHtml(acc)}</td>
            <td><span class="status ${cls}">${icon} ${escapeHtml(statusText)}</span></td>
          </tr>`;
        });
        withdrawalsTbody.innerHTML = html;
      }, err => {
        console.error('withdrawals onSnapshot error', err);
        withdrawalsTbody.innerHTML = '<tr><td colspan="5" style="padding:12px; color:var(--muted)">Could not load withdrawals.</td></tr>';
      });
    }

    // Submit button action
    submitBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      hideError();
      if (!eligible) { alert('Withdrawals restricted to Premium/Gold users. Please upgrade.'); return; }

      const amountRaw = amountInput.value.trim();
      const amount = Number(amountRaw);
      const bank = bankInput.value.trim();
      const accNumber = accNumberInput.value.trim();
      const accName = accNameInput.value.trim();

      // validation
      if (!Number.isFinite(amount) || amount < MIN || amount > MAX) {
        showError(`Amount must be between ₦${MIN} and ₦${MAX}.`);
        return;
      }
      if (!bank) { alert('Select a bank.'); return; }
      if (!accNumber || accNumber.length < 6) { alert('Enter a valid account number.'); return; }
      if (!accName) { alert('Enter account name.'); return; }

      // disable UI while processing
      submitBtn.disabled = true;
      const origText = submitBtn.textContent;
      submitBtn.innerHTML = `<span class="spinner" aria-hidden="true"></span>Processing...`;

      try {
        // Use Firestore transaction to deduct balance atomically and create withdrawal docs
        await runTransaction(db, async (tx) => {
          const uRef = userDocRef;
          const uSnap = await tx.get(uRef);
          if (!uSnap.exists()) throw new Error('User record not found.');
          const uData = uSnap.data();
          const bal = Number(uData.balance || 0);
          const plan = (uData.plan || '').toString().toLowerCase();

          if (!['premium','gold'].includes(plan)) throw new Error('User not eligible to withdraw.');
          if (amount > bal) throw new Error('Insufficient balance.');
          // deduct
          const newBal = bal - amount;
          tx.update(uRef, { balance: newBal });

          // create top-level withdrawal doc for admin (optional) and user sub-doc
          const adminWRef = doc(collection(db, 'withdrawals'));          // top-level admin collection
          const userWRef = doc(collection(uRef, 'withdrawals'));        // user subcollection

          const payload = {
            uid: currentUid,
            amount,
            bank,
            accNumber,
            accName,
            status: 'pending',
            requestedAt: serverTimestamp()
          };
          tx.set(adminWRef, payload);
          tx.set(userWRef, payload);
        });

        // success
        formHint.textContent = 'Withdrawal submitted. Await admin approval.';
        // clear form
        amountInput.value = '';
        bankInput.value = '';
        accNumberInput.value = '';
        accNameInput.value = '';
      } catch (err) {
        console.error('Withdrawal error:', err);
        alert(err.message || 'Could not submit withdrawal.');
      } finally {
        submitBtn.disabled = !eligible;
        submitBtn.textContent = eligible ? 'Submit Withdrawal' : 'Submit Withdrawal';
      }
    });

    // clear form
    clearBtn.addEventListener('click', () => {
      amountInput.value = '';
      bankInput.value = '';
      accNumberInput.value = '';
      accNameInput.value = '';
      hideError();
    });

    // small helper to escape HTML
    function escapeHtml(s){
      return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }
  </script>
</body>
</html>
