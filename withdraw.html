<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EasyPay — Withdrawals</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --accent:#00b66d;
      --accent-700:#0a9a51;
      --bg:#f6fff7;
      --card:#ffffff;
      --muted:#6b7280;
      --text:#102a1f;
      --radius:12px;
      --shadow: 0 12px 30px rgba(6,120,70,0.06);
      --min-withdraw:1000;
      --fee-rate:0.06;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Poppins',system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      background:linear-gradient(180deg,#f8fff9 0%,var(--bg) 100%);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:20px;
    }

    /* Header */
    .header {
      max-width:1100px;
      margin:0 auto 18px auto;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .brand { display:flex; gap:12px; align-items:center; }
    .logo {
      width:48px; height:48px; border-radius:10px;
      display:flex; align-items:center; justify-content:center;
      background:linear-gradient(180deg,var(--accent),var(--accent-700)); color:#fff; font-weight:700;
      box-shadow:var(--shadow);
    }
    h1 { margin:0; font-size:18px; }
    .sub { margin:0; color:var(--muted); font-size:13px; }

    /* Layout */
    .stage {
      max-width:1100px; margin:0 auto;
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:18px;
      align-items:start;
    }

    /* Cards */
    .card {
      background:var(--card); border-radius:var(--radius);
      padding:16px; box-shadow:var(--shadow); border:1px solid rgba(6,120,70,0.04);
    }

    .alert {
      background:#fffdf4; border:1px solid #fff0c2; color:#6a4f05; padding:12px; border-radius:10px; font-weight:700;
      box-shadow:0 8px 20px rgba(6,120,70,0.03);
    }
    .warning {
      margin-top:10px; background:#fff5f5; border:1px solid #ffd6d6; color:#8a1f1f; padding:10px; border-radius:10px; font-weight:700;
    }

    /* Form */
    .form h2 { margin:0 0 10px 0; color:var(--accent); font-size:18px; }
    label { display:block; margin-bottom:6px; font-weight:600; color:#163723; }
    input, select {
      width:100%; padding:12px; border-radius:10px; border:1px solid #e9f6ef; background:#fbfffb; font-size:14px;
    }
    .row { display:flex; gap:12px; }
    .row > * { flex:1; }
    .hint { color:var(--muted); font-size:13px; margin-bottom:10px; }

    .actions { display:flex; gap:10px; margin-top:12px; }
    button.primary {
      background:var(--accent); color:#fff; border:0; padding:12px 16px; border-radius:10px; font-weight:700; cursor:pointer;
      box-shadow:0 10px 24px rgba(6,120,70,0.12);
    }
    button.ghost {
      background:#fff; color:var(--accent); border:1px solid rgba(0,182,109,0.08); padding:10px 14px; border-radius:10px; cursor:pointer;
    }
    button:disabled { opacity:0.6; cursor:not-allowed; box-shadow:none; }

    /* Table */
    .table-wrap { border-radius:10px; overflow:hidden; border:1px solid rgba(6,120,70,0.04); margin-top:12px; }
    table { width:100%; border-collapse:collapse; }
    thead th { background:linear-gradient(90deg,var(--accent),var(--accent-700)); color:#fff; text-align:left; padding:12px; position:sticky; top:0; font-weight:700; }
    tbody td { padding:12px; border-bottom:1px solid #f3fbf5; font-size:14px; color:#163723; }
    tbody tr:nth-child(even) td { background:#fbfff9; }
    .no-log { text-align:center; padding:18px; color:var(--muted); }

    .status { padding:6px 10px; border-radius:8px; color:#fff; font-weight:700; display:inline-block; font-size:13px; }
    .status-pending{ background:#f59f2b; }
    .status-approved{ background:#28a745; }
    .status-rejected{ background:#dc3545; }

    /* summary */
    .summary .box { padding:14px; border-radius:10px; background:linear-gradient(180deg,#fff,#fbfffb); border:1px solid rgba(6,120,70,0.04); }
    .summary strong { display:block; font-size:18px; color:var(--accent); }

    /* modal (keeps simple) */
    .modal-backdrop { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.45); z-index:999; }
    .modal { width:100%; max-width:520px; background:#fff; border-radius:10px; padding:16px; box-shadow:0 20px 40px rgba(0,0,0,0.12); }
    .modal .line { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px dashed #eee; }
    .modal .total { font-weight:800; color:var(--accent); margin-top:6px; }
    .spinner { width:16px; height:16px; border:2px solid #fff; border-top:2px solid transparent; border-radius:50%; animation:spin 1s linear infinite; margin-right:8px; }
    @keyframes spin{ to{transform:rotate(360deg);} }

    /* responsive */
    @media (max-width:980px){
      .stage { padding:0 12px; }
      .header { padding:0 12px; }
      .stage { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="brand">
      <div class="logo">EP</div>
      <div>
        <h1>EasyPay — Withdraw Funds</h1>
        <p class="sub">Withdraw to your bank — processing between 08:00 and 17:00.</p>
      </div>
    </div>
    <div style="text-align:right">
      <div id="userEmail" style="font-weight:700;color:#0b3f2b">—</div>
      <div id="userBalance" style="color:var(--muted);font-size:13px">Balance: ₦0.00</div>
    </div>
  </div>

  <div class="stage">
    <!-- left: form + table -->
    <div>
      <div class="card">
        <div class="alert">Withdrawals take up to 48hrs. Please avoid complaints before then!</div>
        <div class="warning" style="margin-top:12px">⚠️ Multiple withdrawals in a single day will be rejected and not refunded.</div>
      </div>

      <div class="card form" style="margin-top:14px" id="formCard">
        <h2>Make a Withdrawal</h2>
        <div class="hint">Minimum withdrawal is <strong>₦1,000</strong>. Withdrawals processed between 08:00 — 17:00. One non-rejected withdrawal per day.</div>

        <label for="amount">Amount (₦)</label>
        <input id="amount" type="number" min="1000" placeholder="Enter amount (min ₦1,000)">

        <div class="row" style="margin-top:10px">
          <div>
            <label for="bank">Select Bank</label>
            <select id="bank"><option value="">-- Choose Bank --</option><option>Access Bank</option><option>Kuda</option><option>PalmPay</option><option>Moniepoint</option><option>Opay</option><option>GTBank</option><option>First Bank</option><option>UBA</option><option>Zenith Bank</option><option>Wema Bank</option><option>SmartCash PSB</option><option>Momo PSB</option></select>
          </div>
          <div>
            <label for="accNumber">Account Number</label>
            <input id="accNumber" type="text" placeholder="0123456789">
          </div>
        </div>

        <label for="accName" style="margin-top:10px">Account Name</label>
        <input id="accName" type="text" placeholder="Recipient's name">

        <div class="actions">
          <button id="submitBtn" class="primary">Submit Withdrawal</button>
          <button id="clearBtn" class="ghost" type="button">Clear</button>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <h3 style="margin:0 0 12px 0;color:var(--accent)">Recent Withdrawals</h3>
        <div class="table-wrap">
          <table>
            <thead>
              <tr><th>Date</th><th>Amt</th><th>Bank</th><th>Acct</th><th>Status</th></tr>
            </thead>
            <tbody id="withdrawalTable">
              <tr><td colspan="5" class="no-log">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- right: summary -->
    <aside class="card summary">
      <div class="box">
        <strong id="summaryBalance">₦0.00</strong>
        <div style="color:var(--muted); margin-top:6px" id="summaryPlan">Plan: —</div>
      </div>

      <div class="box">
        <strong>Rules & Hours</strong>
        <div style="color:var(--muted); margin-top:6px">Withdrawals daily: 08:00 — 17:00. Only Premium & Gold users allowed. One non-rejected request per day.</div>
      </div>

      <div class="box">
        <strong>Support</strong>
        <div style="color:var(--muted); margin-top:6px">If delayed beyond working hours, contact support.</div>
      </div>
    </aside>
  </div>

  <!-- simple confirmation modal (progressive enhancement, won't change your functions) -->
  <div class="modal-backdrop" id="confirmModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <h3>Confirm Withdrawal</h3>
      <div class="line"><div>Requested</div><div id="m_requested">₦0.00</div></div>
      <div class="line"><div>Fee (6%)</div><div id="m_fee">₦0.00</div></div>
      <div class="line"><div>Amount to receive</div><div id="m_receive"><strong>₦0.00</strong></div></div>
      <div class="line"><div>Bank</div><div id="m_bank">—</div></div>
      <div class="line"><div>Account</div><div id="m_account">—</div></div>
      <div class="line"><div>Your balance</div><div id="m_balance">₦0.00</div></div>
      <div class="total" id="m_total">Net: ₦0.00</div>

      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
        <button id="m_cancel" class="ghost">Cancel</button>
        <button id="m_confirm" class="primary">Confirm & Send</button>
      </div>
    </div>
  </div>

  <script type="module">
    // keep your project config and function names — improved wiring below
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, updateDoc, collection, addDoc,
      query, orderBy, limit, getDocs, onSnapshot, serverTimestamp, where, Timestamp
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    // YOUR FIREBASE CONFIG (left intact)
    const firebaseConfig = {
      apiKey: "AIzaSyDRkip46Ql5KhNfuatWAcAxQzgP5VtQ8UY",
      authDomain: "easypay-6bce8.firebaseapp.com",
      projectId: "easypay-6bce8",
      storageBucket: "easypay-6bce8.firebasestorage.app",
      messagingSenderId: "862671358267",
      appId: "1:862671358267:web:b243c7b69840ef918c1e",
      measurementId: "G-2FZKDQ47FZ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM
    const submitBtn = document.getElementById('submitBtn');
    const clearBtn = document.getElementById('clearBtn');
    const amountEl = document.getElementById('amount');
    const bankEl = document.getElementById('bank');
    const accNameEl = document.getElementById('accName');
    const accNumberEl = document.getElementById('accNumber');
    const withdrawalTable = document.getElementById('withdrawalTable');
    const userEmail = document.getElementById('userEmail');
    const userBalance = document.getElementById('userBalance');
    const summaryBalance = document.getElementById('summaryBalance');
    const summaryPlan = document.getElementById('summaryPlan');

    // modal refs
    const confirmModal = document.getElementById('confirmModal');
    const m_requested = document.getElementById('m_requested');
    const m_fee = document.getElementById('m_fee');
    const m_receive = document.getElementById('m_receive');
    const m_bank = document.getElementById('m_bank');
    const m_account = document.getElementById('m_account');
    const m_balance = document.getElementById('m_balance');
    const m_total = document.getElementById('m_total');
    const m_cancel = document.getElementById('m_cancel');
    const m_confirm = document.getElementById('m_confirm');

    // constants & state
    const allowedPlans = ['premium','gold']; // preserved from original
    const MIN_WITHDRAW = Number(getComputedStyle(document.documentElement).getPropertyValue('--min-withdraw')) || 1000;
    const FEE_RATE = Number(getComputedStyle(document.documentElement).getPropertyValue('--fee-rate')) || 0.06;

    let currentUid = null;
    let currentUserDocUnsub = null;
    let withdrawalsUnsub = null;
    let latestUserData = {};

    // format
    function fmt(n){ return '₦' + (Number(n)||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }
    function round2(n){ return Math.round((Number(n)||0)*100)/100; }
    function clearForm(){ amountEl.value=''; bankEl.value=''; accNameEl.value=''; accNumberEl.value=''; }

    // ---------------------------
    // Original functions (kept logic, largely unchanged)
    // submitWithdrawal and loadWithdrawals are intentionally left compatible with your original code
    // ---------------------------

    async function submitWithdrawal(uid) {
      const btn = submitBtn;
      const orig = btn.textContent;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>Processing...';
      try {
        const amount = parseFloat(document.getElementById('amount').value);
        if (isNaN(amount) || amount < MIN_WITHDRAW) {
          alert(`Please enter a value of at least ₦${MIN_WITHDRAW.toLocaleString()}.`);
          return;
        }
        const bank = document.getElementById('bank').value;
        const accName = document.getElementById('accName').value.trim();
        const accNumber = document.getElementById('accNumber').value.trim();
        if (!bank || !accName || !accNumber) {
          alert('Fill all fields correctly.');
          return;
        }

        const userRef = doc(db, 'users', uid);
        const userDoc = await getDoc(userRef);
        const balance = Number(userDoc.data()?.balance) || 0;
        if (amount > balance) {
          alert('Insufficient balance.');
          return;
        }

        // update balance and create withdrawal record
        await updateDoc(userRef, { balance: balance - amount });
        await addDoc(collection(userRef, 'withdrawals'), { timestamp: serverTimestamp(), amount, bank, accName, accNumber, status: 'pending' });

        alert('Withdrawal submitted.');
        clearForm();
        // keep original behavior: reload withdrawals
        await loadWithdrawals(uid);
      } catch (e) {
        console.error(e);
        alert('Error. Please retry.');
      } finally {
        btn.disabled = false;
        btn.textContent = orig;
      }
    }

    async function loadWithdrawals(uid) {
      const tbody = withdrawalTable;
      tbody.innerHTML = '<tr><td colspan="5" class="no-log">Loading...</td></tr>';
      try {
        const ref = collection(doc(db, 'users', uid), 'withdrawals');
        const q = query(ref, orderBy('timestamp', 'desc'), limit(20));
        const snap = await getDocs(q);
        if (snap.empty) {
          tbody.innerHTML = '<tr><td colspan="5" class="no-log">No withdrawals yet.</td></tr>';
          return;
        }
        tbody.innerHTML = '';
        snap.forEach(ds => {
          const d = ds.data();
          let dt = new Date();
          if (d.timestamp) {
            if (typeof d.timestamp.toDate === 'function') dt = d.timestamp.toDate();
            else if (d.timestamp.seconds) dt = new Date(d.timestamp.seconds * 1000);
            else dt = new Date(d.timestamp);
          }
          const date = dt.toLocaleString();
          const cls = d.status === 'approved' ? 'status-approved' : d.status === 'rejected' ? 'status-rejected' : 'status-pending';
          const icon = d.status && d.status.charAt(0).toLowerCase() === 'a' ? '✅' : d.status && d.status.charAt(0).toLowerCase() === 'r' ? '❌' : '⏳';
          const statusText = d.status ? (d.status.charAt(0).toUpperCase() + d.status.slice(1)) : 'Pending';
          tbody.innerHTML += `<tr><td>${date}</td><td>₦${d.amount}</td><td>${d.bank}</td><td>${d.accNumber || d.acc || '-'}</td><td><span class="status ${cls}">${icon} ${statusText}</span></td></tr>`;
        });
      } catch (err) {
        console.error(err);
        tbody.innerHTML = '<tr><td colspan="5" class="no-log">Failed to load withdrawals</td></tr>';
      }
    }

    // ---------------------------
    // End original functions
    // ---------------------------

    // Realtime / reactive wiring (keeps your firebase config and function behavior,
    // but makes the page respond to user doc and withdrawals changes)
    function cleanupRealtime() {
      if (typeof currentUserDocUnsub === 'function') { try { currentUserDocUnsub(); } catch(e){} currentUserDocUnsub = null; }
      if (typeof withdrawalsUnsub === 'function') { try { withdrawalsUnsub(); } catch(e){} withdrawalsUnsub = null; }
    }

    function normalizeDate(ts){
      if (!ts) return new Date();
      if (typeof ts.toDate === 'function') return ts.toDate();
      if (ts.seconds) return new Date(ts.seconds*1000);
      return new Date(ts);
    }

    // set up listeners when user signs in
    onAuthStateChanged(auth, async user => {
      cleanupRealtime();
      if (!user) {
        // user not signed in: show placeholder and stop
        userEmail.textContent = 'Not signed in';
        userBalance.textContent = 'Balance: ₦0.00';
        summaryBalance.textContent = '₦0.00';
        summaryPlan.textContent = 'Plan: —';
        withdrawalTable.innerHTML = '<tr><td colspan="5" class="no-log">Please sign in</td></tr>';
        return;
      }

      currentUid = user.uid;
      userEmail.textContent = user.email || user.displayName || user.uid;

      try {
        // realtime user doc listener
        const userRef = doc(db, 'users', user.uid);
        currentUserDocUnsub = onSnapshot(userRef, snap => {
          if (!snap.exists()) {
            latestUserData = {};
            userBalance.textContent = 'Balance: ₦0.00';
            summaryBalance.textContent = '₦0.00';
            summaryPlan.textContent = 'Plan: —';
            // still load withdrawals (will be empty)
            loadWithdrawals(user.uid).catch(()=>{});
            return;
          }
          const data = snap.data();
          latestUserData = data || {};
          const bal = Number(data.balance) || 0;
          userBalance.textContent = `Balance: ₦${bal.toLocaleString()}`;
          summaryBalance.textContent = fmt(bal);
          summaryPlan.textContent = `Plan: ${data.plan || data.accountType || data.role || '—'}`;

          // plan gating (preserve original behavior: only premium & gold allowed)
          const plan = (data.plan || data.accountType || data.role || '').toString().toLowerCase();
          if (!allowedPlans.includes(plan)) {
            document.getElementById('formCard').classList.add('disabled');
            Array.from(document.querySelectorAll('#formCard input,#formCard select,#formCard button')).forEach(el => el.disabled = true);
            // optionally show a small notice near form (keeps minimal)
          } else {
            // enable inputs & re-attach submit to show confirmation first
            Array.from(document.querySelectorAll('#formCard input,#formCard select,#formCard button')).forEach(el => el.disabled = false);
            submitBtn.onclick = () => openConfirmModal(user.uid);
          }

          // also update modal balance if visible
          m_balance.textContent = fmt(bal);
        }, err => {
          console.error('user snapshot error', err);
        });

        // realtime withdrawals listener
        const wRef = collection(doc(db, 'users', user.uid), 'withdrawals');
        const wq = query(wRef, orderBy('timestamp', 'desc'), limit(20));
        withdrawalsUnsub = onSnapshot(wq, snap => {
          // render using normalized timestamps
          if (!snap || snap.empty) {
            withdrawalTable.innerHTML = '<tr><td colspan="5" class=
