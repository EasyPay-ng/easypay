<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Memory Flip ‚Äì EasyPay</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --green: #2e7d32;
      --green-light: #e8f5e9;
      --card-bg: #fff;
      --card-back: #a5d6a7;
    }
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background-color: #f0fff0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      text-align: center;
    }
    h1 {
      color: var(--green);
    }
    .board {
      display: grid;
      grid-template-columns: repeat(5, 60px);
      grid-gap: 15px;
      margin-top: 20px;
    }
    .card {
      width: 60px;
      height: 60px;
      perspective: 1000px;
    }
    .card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transition: transform 0.6s;
      transform-style: preserve-3d;
      cursor: pointer;
    }
    .card.flipped .card-inner {
      transform: rotateY(180deg);
    }
    .card-front, .card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      backface-visibility: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
    }
    .card-front {
      background-color: var(--card-bg);
      transform: rotateY(180deg);
    }
    .card-back {
      background-color: var(--card-back);
      color: white;
    }
    #status, #timer {
      margin-top: 10px;
      font-weight: bold;
    }
    .win {
      color: var(--green);
    }
    .error {
      font-size: 1.1rem;
      color: #c00;
      margin-top: 40px;
    }
    .emoji-big {
      font-size: 5rem;
    }
    .upgrade-btn {
      margin-top: 20px;
      background: var(--green);
      color: white;
      padding: 12px 25px;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<h1>üß† Memory Flip Game</h1>
<p>Match all 10 pairs under 60 seconds to earn ‚Ç¶20</p>
<div id="status">Flips: 0</div>
<div id="timer">Time left: 60s</div>
<div class="board" id="board"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDRkip46Ql5KhNfuatWAcAxQzgP5VtQ8UY",
    authDomain: "easypay-6bce8.firebaseapp.com",
    projectId: "easypay-6bce8"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const emojis = ['üçé','üçå','üçá','üçì','üçâ','ü•ù','üçë','üçç','üçã','üçí'];
  let flippedCards = [], matched = 0, flips = 0, currentUser;
  let timerInterval, timeLeft = 60;

  auth.onAuthStateChanged(async (user) => {
    if (!user) return location.href = "login.html";
    currentUser = user;

    const userRef = db.collection("users").doc(user.uid);
    const userDoc = await userRef.get();
    const data = userDoc.data();
    const plan = data?.plan?.toLowerCase();
    const allowedPlans = ["emerald", "titanium", "supreme", "royalty"];

    if (!allowedPlans.includes(plan)) {
      document.body.innerHTML = `
        <div class="emoji-big">üòì</div>
        <div class="error">You're not eligible to access this page.<br>You must be on at least the <strong>Emerald</strong> plan.</div>
        <button class="upgrade-btn" onclick="location.href='upgrade.html'">Upgrade Now</button>
      `;
      return;
    }

    const lastPlayed = data?.lastMemoryFlip;
    const now = Date.now();
    const cooldown = 86400000; // 24 hrs

    if (lastPlayed && now - lastPlayed < cooldown) {
      const nextPlay = new Date(lastPlayed + cooldown);
      const countdownDiv = document.createElement("div");
      countdownDiv.innerHTML = `<h2>‚è≥ You can play again in:</h2><div id="countdown" style="font-size: 1.5rem; font-weight: bold;"></div>`;
      document.body.innerHTML = "";
      document.body.appendChild(countdownDiv);

      const countdown = () => {
        const now = new Date().getTime();
        const distance = nextPlay - now;
        if (distance <= 0) return location.reload();
        const hrs = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const mins = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const secs = Math.floor((distance % (1000 * 60)) / 1000);
        document.getElementById("countdown").innerText = `${hrs}h ${mins}m ${secs}s`;
      };
      countdown();
      setInterval(countdown, 1000);
      return;
    }

    initGame();
  });

  function initGame() {
    const board = document.getElementById("board");
    const pairs = [...emojis, ...emojis];
    shuffle(pairs);
    pairs.forEach((emoji) => {
      const card = document.createElement("div");
      card.classList.add("card");
      card.innerHTML = `
        <div class="card-inner" data-emoji="${emoji}">
          <div class="card-front">${emoji}</div>
          <div class="card-back">‚ùì</div>
        </div>`;
      card.addEventListener("click", () => flipCard(card));
      board.appendChild(card);
    });
    startTimer();
  }

  function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
  }

  function flipCard(card) {
    if (card.classList.contains("flipped") || flippedCards.length === 2) return;
    card.classList.add("flipped");
    flippedCards.push(card);

    if (flippedCards.length === 2) {
      flips++;
      document.getElementById("status").innerText = `Flips: ${flips}`;
      const [card1, card2] = flippedCards;
      const emoji1 = card1.querySelector(".card-inner").dataset.emoji;
      const emoji2 = card2.querySelector(".card-inner").dataset.emoji;

      if (emoji1 === emoji2) {
        matched += 2;
        flippedCards = [];
        if (matched === 20) {
          clearInterval(timerInterval);
          winGame();
        }
      } else {
        setTimeout(() => {
          card1.classList.remove("flipped");
          card2.classList.remove("flipped");
          flippedCards = [];
        }, 800);
      }
    }
  }

  function startTimer() {
    timerInterval = setInterval(() => {
      timeLeft--;
      document.getElementById("timer").innerText = `Time left: ${timeLeft}s`;
      if (timeLeft <= 0) {
        clearInterval(timerInterval);
        document.getElementById("timer").innerHTML = "<span style='color:red;'>‚õî Time's up! Try again tomorrow.</span>";
        document.querySelectorAll(".card").forEach(c => c.style.pointerEvents = "none");
        if (currentUser) {
          db.collection("users").doc(currentUser.uid).update({
            lastMemoryFlip: Date.now()
          });
        }
      }
    }, 1000);
  }

  async function winGame() {
    document.getElementById("timer").innerHTML = `<span class='win'>‚úÖ You matched all cards! ‚Ç¶20 has been credited.</span>`;
    const userRef = db.collection("users").doc(currentUser.uid);
    await userRef.update({ lastMemoryFlip: Date.now() });

    const userDoc = await userRef.get();
    const newBalance = (userDoc.data().balance || 0) + 20;
    await userRef.update({ balance: newBalance });

    await db.collection("users").doc(currentUser.uid).collection("transactions").add({
      source: "Memory Flip Game",
      amount: 20,
      date: new Date().toISOString()
    });
  }
</script>
</body>
</html>
