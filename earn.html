<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EasyPay – Available Tasks</title>
  <style>
    body { margin: 0; padding: 20px; font-family: 'Segoe UI', sans-serif; background-color: #f8fff8; }
    #loginDiv, #app { max-width: 800px; margin: auto; }
    #loginDiv { text-align: center; padding-top: 50px; }
    #loginDiv input { width: 100%; padding: 10px; margin: 8px 0; border-radius: 6px; border: 1px solid #ccc; }
    #loginDiv button { padding: 10px 20px; background: #006400; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; }
    #loginError { color: red; margin-top: 8px; }
    #app { display: none; }
    #logoutBtn { float: right; padding: 6px 12px; background: #006400; color: #fff; border: none; border-radius: 6px; cursor: pointer; }
    header { text-align: center; color: #006400; font-size: 2em; margin-bottom: 20px; }
    .task { background: #fff; border: 1px solid #ccc; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .task h2 { margin: 0 0 10px; color: #006400; font-size: 1.5em; }
    .task p { margin: 8px 0; line-height: 1.4; }
    .proof { margin-top: 15px; }
    .proof label { display: block; margin-bottom: 4px; font-weight: bold; }
    .proof textarea, .proof input[type=file] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 10px; }
    .submit-btn { padding: 8px 16px; background: #007700; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
    .upload-progress-container { background: #eee; border-radius: 10px; overflow: hidden; height: 10px; margin-bottom: 4px; display: none; }
    .upload-progress-bar { height: 100%; width: 0%; transition: width 0.2s ease; }
    .upload-progress-label { font-size: 11px; text-align: right; color: #004400; display: none; }
  </style>
</head>
<body>  <div id="loginDiv">
    <h2>Sign In to Continue</h2>
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="Password" />
    <button id="loginBtn">Sign In</button>
    <p id="loginError"></p>
  </div>  <div id="app">
    <button id="logoutBtn">Sign Out</button>
    <header>EasyPay – Available Tasks</header>
    <div id="loading">Loading tasks...</div>
    <div id="taskContainer"></div>
  </div>  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>  <script>
    // Firebase config
    const firebaseConfig = { /* your config */ };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(), db = firebase.firestore();

    // DOM refs
    const loginDiv      = document.getElementById('loginDiv');
    const appDiv        = document.getElementById('app');
    const loginBtn      = document.getElementById('loginBtn');
    const logoutBtn     = document.getElementById('logoutBtn');
    const emailEl       = document.getElementById('email');
    const passEl        = document.getElementById('password');
    const loginError    = document.getElementById('loginError');
    const loadingEl     = document.getElementById('loading');
    const taskContainer = document.getElementById('taskContainer');

    let currentUid;

    // Sign in
    loginBtn.onclick = () => {
      loginError.textContent = '';
      auth.signInWithEmailAndPassword(emailEl.value, passEl.value)
        .catch(err => loginError.textContent = err.message);
    };
    // Sign out
    logoutBtn.onclick = () => auth.signOut();

    // Auth listener
    auth.onAuthStateChanged(async user => {
      if (user) {
        currentUid = user.uid;
        loginDiv.style.display = 'none';
        appDiv.style.display   = 'block';
        subscribeUserSubs();
        await loadTasks();
      } else {
        currentUid = null;
        loginDiv.style.display = 'block';
        appDiv.style.display   = 'none';
      }
    });

    // Real-time listener for user's submissions
    function subscribeUserSubs() {
      db.collection('task_submissions')
        .where('userId','==',currentUid)
        .onSnapshot(snapshot => {
          snapshot.docChanges().forEach(change => {
            const s = change.doc.data();
            if (s.taskId) {
              const el = document.getElementById(`task-${s.taskId}`);
              if (s.status !== 'rejected' && el) {
                // pending or approved → remove immediately
                el.remove();
              }
              if (s.status === 'rejected') {
                // rejected → reload tasks so it reappears
                loadTasks();
              }
            }
          });
        });
    }

    // Load tasks logic
    async function loadTasks() {
      loadingEl.textContent = 'Loading tasks...';
      taskContainer.innerHTML = '';
      try {
        const tasksSnap = await db.collection('tasks').where('status','==','approved').get();
        const tasks = tasksSnap.docs.sort((a,b)=> (b.data().createdAt?.toMillis()||0) - (a.data().createdAt?.toMillis()||0));
        loadingEl.style.display = 'none';
        for (let doc of tasks) {
          const data = doc.data(), id = doc.id;
          // count global approvals
          const globalApproved = (await db.collection('task_submissions')
            .where('taskId','==',id).where('status','==','approved').get()).size;
          if (globalApproved >= data.workersNeeded) continue;
          // skip if user has pending/approved
          const userSnap = await db.collection('task_submissions')
            .where('taskId','==',id).where('userId','==',currentUid).get();
          const hasActive = userSnap.docs.some(d=>d.data().status!=='rejected');
          if (!hasActive) renderTask(id,data);
        }
      } catch(e) {
        loadingEl.textContent = 'Error loading tasks: ' + e.message;
      }
    }

    // Render with proofs and submit logic (unchanged)...
  </script></body>
</html>
