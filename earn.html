<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EasyPay – Available Tasks</title>

  <!-- Improved styles only (no function changes) -->
  <style>
    :root{
      --bg:#f7fff8;
      --accent:#009f4d;
      --accent-dark:#07723a;
      --muted:#5f6a63;
      --card:#ffffff;
      --radius:12px;
      --shadow: 0 10px 30px rgba(0,0,0,0.06);
      --glass: rgba(255,255,255,0.6);
    }

    /* base */
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; font-family: 'Segoe UI', Roboto, Arial, sans-serif;
      background: linear-gradient(180deg,#f8fff9 0%,var(--bg) 100%);
      color:#173522; padding:28px;
    }

    /* container */
    .wrap { max-width:980px; margin:0 auto; display:flex; flex-direction:column; gap:18px; min-height:100vh; }
    header.top {
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      background:linear-gradient(90deg,var(--accent),var(--accent-dark));
      color:#fff; padding:14px 18px; border-radius:12px; box-shadow:var(--shadow);
    }
    header.top h1{ margin:0; font-size:18px; font-weight:700; letter-spacing:0.2px; }
    header.top .sub{ font-size:13px; opacity:0.95; }

    /* main region */
    .main { display:grid; grid-template-columns: 1fr 320px; gap:18px; align-items:start; }

    /* left column */
    .left { display:flex; flex-direction:column; gap:16px; }

    /* loading area (keeps original id loading) */
    #loading {
      display:flex; align-items:center; gap:12px; color:var(--muted); font-weight:600;
      padding:12px; background: linear-gradient(180deg,#fff,#fcfff9); border-radius:10px;
      border:1px solid rgba(6,120,70,0.04); box-shadow: 0 8px 20px rgba(6,120,70,0.03);
    }

    /* spinner overlay (new) */
    .spinner-overlay {
      position:relative;
    }
    .spinner-layer {
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.6));
      z-index:30; border-radius:10px;
    }
    .spinner {
      width:44px; height:44px; border-radius:50%;
      border:4px solid rgba(0,0,0,0.08); border-top-color:var(--accent); animation:spin 0.9s linear infinite;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    }
    @keyframes spin { to { transform:rotate(360deg); } }

    /* task card improved */
    .task {
      background:var(--card);
      border-radius:12px;
      padding:16px;
      box-shadow: 0 10px 30px rgba(6,120,70,0.04);
      border:1px solid rgba(6,120,70,0.04);
      display:flex;
      flex-direction:column;
      gap:12px;
      position:relative;
      overflow:visible;
    }
    .task h2 { margin:0; color:var(--accent-dark); font-size:16px; font-weight:700; }
    .task .meta { display:flex; gap:12px; align-items:center; color:var(--muted); font-size:13px; }
    .task p { margin:0; color:#234033; line-height:1.45; }

    .progress-container { height:12px; background:#eef7ef; border-radius:999px; overflow:hidden; }
    .progress-bar { height:100%; background:linear-gradient(90deg,var(--accent),var(--accent-dark)); width:0%; transition:width .35s ease; }

    .task .actions { display:flex; gap:10px; justify-content:flex-end; margin-top:6px; }
    .start-btn, .submit-btn {
      background:var(--accent); color:#fff; border:0; padding:8px 14px; border-radius:8px; cursor:pointer; font-weight:700;
      box-shadow: 0 8px 20px rgba(0,0,0,0.06);
    }
    .start-btn:hover, .submit-btn:hover { transform:translateY(-2px); transition:transform .12s ease; }

    .proof { margin-top:6px; display:grid; gap:8px; }
    .proof label { font-weight:700; color:#173522; font-size:14px; }
    .proof textarea { min-height:76px; padding:10px; border-radius:8px; border:1px solid #e9f6ef; resize:vertical; }
    .proof input[type=file] { padding:8px; border-radius:8px; background:#fcfffc; border:1px dashed #e6f4ec; }

    .upload-progress-container { height:8px; background:#eef7ef; border-radius:999px; overflow:hidden; display:none; }
    .upload-progress-bar { height:100%; width:0%; transition:width .12s linear; background:linear-gradient(90deg,var(--accent),var(--accent-dark)); }

    /* right column */
    aside.card {
      background:var(--card); border-radius:12px; padding:16px; box-shadow:var(--shadow);
      border:1px solid rgba(6,120,70,0.04);
      height:fit-content;
    }
    aside.card h3 { margin:0 0 8px 0; color:var(--accent-dark); font-size:16px; }
    aside.card p { margin:0; color:var(--muted); font-size:13px; }

    /* responsive */
    @media (max-width:940px) {
      .main { grid-template-columns: 1fr; }
      .wrap { padding:12px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="top">
      <div>
        <h1>EasyPay — Available Tasks</h1>
        <div class="sub">Complete verified tasks to earn</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="logoutBtn" style="background:#fff;color:var(--accent);padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700">Sign Out</button>
      </div>
    </header>

    <main class="main">
      <div class="left">
        <!-- loading indicator (original id preserved) -->
        <div id="loading" aria-live="polite">
          <!-- text is controlled by your original functions (we preserve that) -->
          Loading tasks...
        </div>

        <!-- task area with spinner overlay -->
        <div class="spinner-overlay" style="position:relative;">
          <!-- spinner-layer will be toggled by the enhancement script below -->
          <div class="spinner-layer" id="spinnerLayer" style="display:flex;">
            <div class="spinner" aria-hidden="true"></div>
          </div>

          <div id="taskContainer" style="display:flex;flex-direction:column;gap:12px;margin-top:6px;">
            <!-- tasks inserted here by your original renderTask -->
          </div>
        </div>
      </div>

      <!-- right column (summary / tips) -->
      <aside class="card">
        <h3>How it works</h3>
        <p style="margin-bottom:10px">Open a task, follow instructions, submit proof (text + image). Approved submissions pay the listed amount. Abuse may result in reversal.</p>
        <h3 style="margin-top:12px">Tips</h3>
        <p>- Use clear screenshots for faster approval.<br>- Write concise proof text describing your action.<br>- Check worker limits — completed tasks disappear.</p>
      </aside>
    </main>
  </div>

  <!-- ORIGINAL firebase compat libs & original script (unchanged functions) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    /* ---------- ORIGINAL CODE START (exact functions preserved) ---------- */
    const firebaseConfig = { apiKey: "AIzaSyDRkip46Ql5KhNfuatWAcAxQzgP5VtQ8UY", authDomain: "easypay-6bce8.firebaseapp.com", projectId: "easypay-6bce8", storageBucket: "easypay-6bce8.appspot.com", messagingSenderId: "862671358267", appId: "1:862671358267:web:b243c7b69840ef918c1e" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(), db = firebase.firestore();

    const loginDiv = document.getElementById('loginDiv'),
          appDiv = document.getElementById('app'),
          loginBtn = document.getElementById('loginBtn'),
          logoutBtn = document.getElementById('logoutBtn'),
          emailEl = document.getElementById('email'),
          passEl = document.getElementById('password'),
          loginError = document.getElementById('loginError'),
          loadingEl = document.getElementById('loading'),
          taskContainer = document.getElementById('taskContainer');

    // The original app used auth handlers; keep them as-is (we assume page uses same flow)
    // NOTE: in your provided snippet you used auth.onAuthStateChanged and functions below.
    // We'll reuse those exact functions (copy from user's original snippet) but adapted to
    // look for existing DOM IDs in this improved UI.

    // For safety: if login UI elements are missing in this file (we moved them earlier),
    // original auth flows will still use auth.onAuthStateChanged where needed by your environment.
    // If you embed this page into a larger app, your existing login flow will still work.

    // We re-implement your original functions unchanged (loadTasks, renderTask, uploadToImgur, submitProof)
    // — only minor DOM ID differences handled (taskContainer & loading kept same).

    auth.onAuthStateChanged(async user => {
      if (user) {
        // There was loginDiv/appDiv in original — skip showing/hiding here since header includes sign out btn.
        // Call loadTasks with user.uid
        await loadTasks(user.uid);
        db.collection('task_submissions')
          .where('userId', '==', user.uid)
          .onSnapshot(() => loadTasks(user.uid));
      } else {
        // user not signed in — show loading as message
        loadingEl.textContent = 'Please sign in';
      }
    });

    async function loadTasks(uid) {
      loadingEl.textContent = 'Loading tasks...';
      taskContainer.innerHTML = '';
      try {
        const [tasksSnap, userSubsSnap] = await Promise.all([
          db.collection('tasks').where('status','==','approved').get(),
          db.collection('task_submissions').where('userId','==',uid).get()
        ]);
        const skipIds = new Set(
          userSubsSnap.docs.map(d => d.data()).filter(s => s.status !== 'rejected').map(s => s.taskId)
        );
        const tasks = tasksSnap.docs.sort((a,b) => (b.data().createdAt?.toMillis()||0) - (a.data().createdAt?.toMillis()||0));
        loadingEl.style.display = 'none';
        for (let doc of tasks) {
          const data = doc.data(), id = doc.id;
          if (skipIds.has(id)) continue;
          const globalApproved = (await db.collection('task_submissions')
            .where('taskId','==',id).where('status','==','approved').get()).size;
          if (globalApproved < data.workersNeeded) renderTask(id, data);
        }
      } catch(e) {
        loadingEl.style.display = '';
        loadingEl.textContent = 'Error loading tasks: ' + (e.message || e);
      }
    }

    function renderTask(id, data) {
      const price = data.costPerUser || (data.totalBudget/data.workersNeeded);
      const userPay = +(price*0.7).toFixed(2);
      const div = document.createElement('div'); div.className='task'; div.id=`task-${id}`;
      div.innerHTML = `
        <h2>${data.taskTitle} — ${data.category}</h2>
        <p>${data.description||''}</p>
        <div class="meta"><strong>Earn:</strong> ₦${userPay} &nbsp; • &nbsp; ${data.workersNeeded} slots</div>
        <div class="progress-container"><div class="progress-bar" id="bar-${id}"></div></div>
        <div class="progress-label" id="label-${id}">0 / ${data.workersNeeded} completed</div>

        <div style="display:flex;gap:8px;justify-content:flex-end;">
          <button class="start-btn" onclick="window.open('${data.link}','_blank')">Start Task</button>
        </div>

        <div class="proof">
          <label>Text Proof:</label>
          <textarea id="text-${id}" placeholder="Enter text proof..."></textarea>
          <label>Upload Image Proof:</label>
          <input type="file" id="file_${id}" accept="image/*" />
          <div class="upload-progress-container" id="upload-container-${id}">
            <div class="upload-progress-bar" id="upload-bar-${id}"></div>
          </div>
          <div class="upload-progress-label" id="upload-label-${id}" style="text-align:right;color:var(--muted);font-size:12px;display:none"></div>
          <div style="display:flex;justify-content:flex-end;margin-top:8px">
            <button id="submit-${id}" class="submit-btn">Submit Proof</button>
          </div>
        </div>
      `;
      taskContainer.appendChild(div);
      document.getElementById(`submit-${id}`).onclick = () => submitProof(id, userPay);
      db.collection('task_submissions')
        .where('taskId','==',id).where('status','==','approved')
        .onSnapshot(snap => {
          const done = snap.size;
          const pct = Math.min(100,Math.round(done/data.workersNeeded*100));
          const barEl = document.getElementById(`bar-${id}`);
          const labelEl = document.getElementById(`label-${id}`);
          if (barEl) barEl.style.width = pct + '%';
          if (labelEl) labelEl.textContent = `${done} / ${data.workersNeeded} completed`;
          if (done>=data.workersNeeded) {
            const el = document.getElementById(`task-${id}`);
            if (el) el.remove();
          }
        });
    }

    function uploadToImgur(file,onProgress){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>{const b=r.result.split(',')[1],f=new FormData();f.append('image',b);const x=new XMLHttpRequest();x.open('POST','https://api.imgur.com/3/image');x.setRequestHeader('Authorization','Client-ID fb533db21a59486');x.upload.onprogress=e=>e.lengthComputable&&onProgress(Math.round(e.loaded/e.total*100));x.onload=()=>{try{const j=JSON.parse(x.responseText);if(j&&j.success)res(j.data.link);else rej((j&&j.data&&j.data.error)||'Upload failed')}catch(err){rej('Invalid response')}};x.onerror=()=>rej('Upload failed (network)');x.send(f)};r.onerror=()=>rej('File read error');r.readAsDataURL(file);});}

    async function submitProof(taskId,payout){const t=document.getElementById(`text-${taskId}`),f=document.getElementById(`file_${taskId}`);const txt=t.value.trim(),file=f.files[0];if(!txt||!file)return alert('Please provide text proof and an image.');const bar=document.getElementById(`upload-bar-${taskId}`),lbl=document.getElementById(`upload-label-${taskId}`),ctr=document.getElementById(`upload-container-${taskId}`);if(ctr)ctr.style.display='block';if(lbl)lbl.style.display='block';try{const url=await uploadToImgur(file,p=>{if(bar)bar.style.width=p+'%';if(lbl)lbl.textContent=p+'%';});const u=auth.currentUser;await db.collection('task_submissions').add({taskId,userId:u.uid,username:u.email||u.displayName,textProof:txt,imageProof:url,payout,status:'pending',submittedAt:firebase.firestore.FieldValue.serverTimestamp()});if(lbl)lbl.textContent='Submitted';const el = document.getElementById(`task-${taskId}`); if (el) el.remove();setTimeout(()=>{if(ctr)ctr.style.display='none';if(lbl)lbl.style.display='none';if(bar)bar.style.width='0%';t.value='';f.value=null},1000)}catch(e){if(lbl)lbl.textContent='Error: '+(e.message||e);console.error(e)} }
    /* ---------- ORIGINAL CODE END ---------- */
  </script>

  <!-- ENHANCEMENT: spinner + responsive behavior (appended; does not alter your functions) -->
  <script>
    (function(){
      const spinnerLayer = document.getElementById('spinnerLayer');
      const taskContainer = document.getElementById('taskContainer');
      const loadingEl = document.getElementById('loading');

      // Show spinner initially (until tasks render)
      function showSpinner(){ spinnerLayer.style.display = 'flex'; }
      function hideSpinner(){ spinnerLayer.style.display = 'none'; }

      // If there are tasks present hide spinner; otherwise show.
      function updateSpinnerByTasks(){
        const hasTasks = taskContainer.children.length > 0;
        if (hasTasks) hideSpinner();
        else {
          // If your loading element explicitly hidden by original script, keep hidden.
          // If loadingEl is visible and says "Loading", show spinner.
          const loadingVisible = loadingEl && loadingEl.style.display !== 'none';
          if (loadingVisible) showSpinner(); else hideSpinner();
        }
      }

      // Observe additions/removals in taskContainer
      const mo = new MutationObserver(mutations => {
        updateSpinnerByTasks();
      });
      mo.observe(taskContainer, { childList: true, subtree: false });

      // Also watch display style on loadingEl (original code hides it when ready)
      const observer = new MutationObserver(() => updateSpinnerByTasks());
      observer.observe(loadingEl, { attributes: true, attributeFilter: ['style', 'class'] });

      // Safety: hide spinner after 12 seconds if nothing happened (prevents stuck spinner)
      const SAFETY_TIMEOUT = 12000;
      let safeTimer = setTimeout(()=> {
        updateSpinnerByTasks();
      }, SAFETY_TIMEOUT);

      // Run initial check
      updateSpinnerByTasks();

      // Also hide spinner when user scrolls into container (UX nicety)
      taskContainer.addEventListener('scroll', () => updateSpinnerByTasks());

      // Clean-up on unload
      window.addEventListener('beforeunload', ()=> { mo.disconnect(); observer.disconnect(); clearTimeout(safeTimer); });
    })();
  </script>
</body>
</html>
