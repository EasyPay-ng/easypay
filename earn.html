<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EasyPay — Available Tasks (Fit-to-Page)</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #f6fff7;
      --card: #ffffff;
      --accent: #00b66d;
      --accent-700: #059c56;
      --muted: #6b7280;
      --text: #0f1720;
      --glass: rgba(255,255,255,0.7);
      --shadow: 0 12px 30px rgba(16,24,40,0.06);
      --radius: 14px;
      --max-width: 1100px;
    }

    /* base / full-height layout */
    html,body { height:100%; }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:'Poppins',system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      background: linear-gradient(180deg,#f8fff9 0%,var(--bg) 100%);
      color:var(--text); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      display:flex; flex-direction:column; min-height:100vh;
      padding:12px; /* small outer padding */
      overflow:hidden; /* we'll manage scroll inside */
    }

    /* centered app wrapper that fills viewport height */
    #fitWrapper { width:100%; height:100%; display:flex; align-items:stretch; justify-content:center }
    .wrap { max-width:var(--max-width); margin:0 auto; width:100%; display:flex; flex-direction:column; height:100%; }

    /* NAV */
    .nav {
      display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; flex:0 0 auto;
    }
    .brand { display:flex; gap:14px; align-items:center }
    .logo { width:64px; height:64px; border-radius:14px; display:flex; align-items:center; justify-content:center; background:linear-gradient(135deg,var(--accent),var(--accent-700)); color:#fff; font-weight:700; font-size:20px; box-shadow:var(--shadow); }
    .brand h1 { margin:0; font-size:20px }
    .brand p { margin:0; font-size:13px; color:var(--muted) }

    .nav-actions { display:flex; gap:12px; align-items:center }
    .btn { background:var(--accent); color:#fff; border:0; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:700; box-shadow: 0 8px 18px rgba(0,0,0,0.06); display:inline-flex; gap:10px; align-items:center }
    .btn.ghost { background:#fff; color:var(--accent); border:1px solid #e9f7ef }
    .pill { background:#fff; padding:8px 12px; border-radius:999px; display:inline-flex; align-items:center; gap:10px; box-shadow:0 6px 18px rgba(10,40,20,0.03); }
    .pill strong { color:var(--accent-700) }

    /* layout: content fills remaining space; task list scrolls inside */
    .content { display:grid; grid-template-columns: 1fr 320px; gap:14px; align-items:start; flex:1 1 auto; min-height:0; }

    /* TASK LIST - make this area scrollable so the whole page fits */
    .task-column { display:flex; flex-direction:column; gap:10px; min-height:0; }
    .task-list-container { background:var(--card); border-radius:14px; padding:10px; box-shadow:var(--shadow); border:1px solid #eef7f0; flex:0 0 auto }

    .task-list { display:grid; gap:10px; padding:10px; overflow:auto; min-height:0; }

    .task-card { background:var(--card); border-radius:12px; padding:12px; box-shadow:0 8px 18px rgba(10,40,20,0.03); border:1px solid #f1fbf4; display:flex; gap:10px; align-items:flex-start }
    .task-main { flex:1 }
    .task-title { margin:0 0 6px 0; font-size:16px; color:var(--accent-700) }
    .task-meta { font-size:13px; color:var(--muted); margin-bottom:6px }
    .task-desc { color:#23312c; margin:0 0 10px 0; line-height:1.4 }

    .task-side { min-width:120px; text-align:right }
    .task-side .earn { font-weight:800; color:var(--accent-700); font-size:16px }
    .task-side small { display:block; color:var(--muted); margin-top:6px }

    .progress { margin-top:8px }
    .progress-bar { height:8px; background:#eef7ef; border-radius:999px; overflow:hidden }
    .progress-bar > i { display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--accent),var(--accent-700)); transition:width .3s ease }
    .progress-info { font-size:12px; color:var(--muted); margin-top:6px }

    /* sidebar */
    .sidebar { position:sticky; top:12px; display:flex; flex-direction:column; gap:10px; align-self:start }
    .card { background:var(--card); border-radius:12px; padding:10px; box-shadow:var(--shadow); border:1px solid #eef7f0 }
    .muted { color:var(--muted) }

    /* modal for proof submission */
    .modal-backdrop { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.45); z-index:999 }
    .modal { width:100%; max-width:520px; background:#fff; border-radius:12px; padding:14px; box-shadow:0 20px 40px rgba(0,0,0,0.18) }
    .modal h3 { margin:0 0 8px 0 }
    .modal label { font-weight:600; font-size:13px; color:#1c2a29 }
    .modal textarea { width:100%; min-height:90px; padding:8px; margin-top:8px; border-radius:8px; border:1px solid #e6f4ec; resize:vertical }
    .modal .row { display:flex; gap:8px; margin-top:10px; align-items:center }
    .modal .row input[type=file] { flex:1 }
    .modal .actions { display:flex; justify-content:flex-end; gap:8px; margin-top:10px }

    .small { font-size:13px }

    /* fit-to-page helper: use transform to scale content to viewport when needed */
    .fit-scale { transform-origin: top center; will-change: transform; }

    /* responsive tweaks */
    @media (max-width:640px){
      .logo { width:48px; height:48px; font-size:16px }
      .brand h1 { font-size:18px }
      .content { grid-template-columns: 1fr; }
      .sidebar { position:relative; top:0 }
      .nav-actions { gap:8px }
    }
  </style>
</head>
<body>
  <div id="fitWrapper">
    <div class="wrap fit-scale" id="appWrap">
      <nav class="nav">
        <div class="brand">
          <div class="logo">EP</div>
          <div>
            <h1>EasyPay — Available Tasks</h1>
            <p class="muted">Complete tasks, upload proof, get paid. Honest users move faster.</p>
          </div>
        </div>

        <div class="nav-actions">
          <div class="pill"><span class="muted">Signed in as</span><strong id="userEmail">—</strong></div>
          <div class="pill small"><span class="muted">Balance</span><strong id="userBalance">₦0.00</strong></div>
          <button id="logoutBtn" class="btn ghost">Sign Out</button>
        </div>
      </nav>

      <div class="content">
        <section class="task-column">
          <div class="task-list-container">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:12px">
              <div>
                <h3 style="margin:0">Available Tasks</h3>
                <p class="muted small" id="taskSummary">Loading…</p>
              </div>

              <div style="display:flex; gap:8px; align-items:center">
                <input id="search" placeholder="Search tasks" style="padding:8px 12px; border-radius:10px; border:1px solid #eef7f0" />
                <button id="refreshBtn" class="btn">Refresh</button>
              </div>
            </div>
          </div>

          <div class="task-list" id="taskContainer" aria-live="polite"></div>
        </section>

        <aside class="sidebar">
          <div class="card">
            <h4 style="margin:0 0 8px 0">How it works</h4>
            <p class="muted small">Open the task link, follow instructions, then submit text + image proof. Submissions are reviewed — approved items pay out the listed amount.</p>
          </div>

          <div class="card">
            <h4 style="margin:0 0 8px 0">Tips</h4>
            <ul style="margin:0; padding-left:18px; color:var(--muted)">
              <li>Use clear screenshots and concise proof text.</li>
              <li>Include time and brief description in your proof.</li>
              <li>Don't submit duplicates — repeated attempts may be rejected.</li>
            </ul>
          </div>

          <div class="card">
            <h4 style="margin:0 0 8px 0">Need help?</h4>
            <p class="muted small">Contact support via WhatsApp or the admin panel.</p>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <!-- modal for proof submission -->
  <div class="modal-backdrop" id="proofModal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle">Submit Proof</h3>
      <p class="muted small" id="modalTaskTitle">Task title</p>

      <label for="proofText">Text proof</label>
      <textarea id="proofText" placeholder="What you did, time, link or reference"></textarea>

      <div class="row">
        <label style="min-width:80px">Image</label>
        <input type="file" id="proofFile" accept="image/*" />
      </div>

      <div class="row" style="margin-top:10px">
        <div class="progress-bar" style="flex:1"><i id="uploadIndicator"></i></div>
        <div style="min-width:60px; text-align:right" id="uploadPercent">0%</div>
      </div>

      <div class="actions">
        <button id="cancelModal" class="btn ghost">Cancel</button>
        <button id="confirmSubmit" class="btn">Submit Proof</button>
      </div>
    </div>
  </div>

  <!-- Firebase compat libs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    // config (unchanged)
    const firebaseConfig = {
      apiKey: "AIzaSyDRkip46Ql5KhNfuatWAcAxQzgP5VtQ8UY",
      authDomain: "easypay-6bce8.firebaseapp.com",
      projectId: "easypay-6bce8",
      storageBucket: "easypay-6bce8.appspot.com",
      messagingSenderId: "862671358267",
      appId: "1:862671358267:web:b243c769840ef918c1e"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(), db = firebase.firestore();

    // UI refs
    const taskContainer = document.getElementById('taskContainer');
    const taskSummary = document.getElementById('taskSummary');
    const refreshBtn = document.getElementById('refreshBtn');
    const searchInput = document.getElementById('search');
    const proofModal = document.getElementById('proofModal');
    const proofText = document.getElementById('proofText');
    const proofFile = document.getElementById('proofFile');
    const uploadIndicator = document.getElementById('uploadIndicator');
    const uploadPercent = document.getElementById('uploadPercent');
    const modalTaskTitle = document.getElementById('modalTaskTitle');
    const confirmSubmit = document.getElementById('confirmSubmit');
    const cancelModal = document.getElementById('cancelModal');
    const userEmailEl = document.getElementById('userEmail');
    const userBalanceEl = document.getElementById('userBalance');
    const logoutBtn = document.getElementById('logoutBtn');
    const appWrap = document.getElementById('appWrap');

    let currentUser = null;
    let openTask = null; // { id, data, payout }

    // Fit-to-page: scale appWrap to fit viewport height when needed
    function scaleToFit() {
      // reset transform to measure natural height
      appWrap.style.transform = '';
      const wrapper = document.getElementById('fitWrapper');
      const availableH = wrapper.clientHeight; // viewport available inside padding
      const neededH = appWrap.scrollHeight; // natural height
      // Only scale when content is taller than available height
      if (neededH > availableH) {
        const scale = Math.max(0.5, availableH / neededH); // min scale 0.5 for readability
        appWrap.style.transform = `scale(${scale})`;
        // center horizontally when scaled
        appWrap.style.margin = '0 auto';
      } else {
        appWrap.style.transform = '';
        appWrap.style.margin = '';
      }
    }

    // call on load and on resize/orientation change
    window.addEventListener('load', () => { setTimeout(scaleToFit, 150); });
    window.addEventListener('resize', () => { setTimeout(scaleToFit, 80); });
    window.addEventListener('orientationchange', () => { setTimeout(scaleToFit, 150); });

    // auth
    logoutBtn.onclick = () => auth.signOut();

    auth.onAuthStateChanged(async user => {
      if (!user) return; // page should show login elsewhere
      currentUser = user;
      userEmailEl.textContent = user.email || (user.displayName || '');
      // fetch simple balance if present
      const udoc = await db.collection('users').doc(user.uid).get().catch(()=>null);
      if (udoc && udoc.exists) userBalanceEl.textContent = '₦' + ((udoc.data().balance||0).toFixed(2));
      await loadTasks(user.uid);
      // live updates on user's own submissions to refresh available tasks
      db.collection('task_submissions').where('userId','==',user.uid).onSnapshot(()=> loadTasks(user.uid));
    });

    refreshBtn.onclick = () => currentUser && loadTasks(currentUser.uid);
    searchInput.addEventListener('input', () => currentUser && loadTasks(currentUser.uid));

    async function loadTasks(uid) {
      taskContainer.innerHTML = '';
      taskSummary.textContent = 'Loading tasks...';
      try {
        const [tasksSnap, userSubsSnap] = await Promise.all([
          db.collection('tasks').where('status','==','approved').get(),
          db.collection('task_submissions').where('userId','==',uid).get()
        ]);

        const userSubMap = new Set(userSubsSnap.docs.map(d=>d.data()).filter(s=>s.status!=='rejected').map(s=>s.taskId));
        const tasks = tasksSnap.docs.map(d=>({ id:d.id, data:d.data() }));
        // sort by createdAt if present
        tasks.sort((a,b)=> (b.data.createdAt?.toMillis?.()||0) - (a.data.createdAt?.toMillis?.()||0));

        // apply search filter
        const q = (searchInput.value || '').trim().toLowerCase();

        let available = 0;
        for (const t of tasks) {
          if (userSubMap.has(t.id)) continue; // user already submitted
          if (q && !(t.data.taskTitle || '').toLowerCase().includes(q) && !(t.data.description||'').toLowerCase().includes(q)) continue;

          // check global approvals to avoid over-serving the task
          const approvedSnap = await db.collection('task_submissions').where('taskId','==',t.id).where('status','==','approved').get();
          const approvedCount = approvedSnap.size;
          if (approvedCount < (t.data.workersNeeded || 1)) {
            renderTask(t.id, t.data);
            available++;
          }
        }

        taskSummary.textContent = `${available} task(s) available`;
        // After tasks render, ensure fit-to-page scaling updates
        setTimeout(scaleToFit, 80);
      } catch (err) {
        console.error('loadTasks error', err);
        taskSummary.textContent = 'Error loading tasks';
      }
    }

    function renderTask(id, data) {
      const price = data.costPerUser || ((data.totalBudget||0) / (data.workersNeeded||1));
      const userPay = +(price*0.7).toFixed(2);

      const card = document.createElement('div');
      card.className = 'task-card';
      card.id = `task-${id}`;
      card.innerHTML = `
        <div class="task-main">
          <h3 class="task-title">${escapeHtml(data.taskTitle || 'Untitled Task')}</h3>
          <div class="task-meta">${escapeHtml(data.category || 'General')} • ${escapeHtml(String(data.workersNeeded || 1))} slots</div>
          <p class="task-desc">${escapeHtml(data.description || '')}</p>
          <div class="progress">
            <div class="progress-bar"><i id="pbar-${id}"></i></div>
            <div class="progress-info" id="plabel-${id}">0 / ${data.workersNeeded || 1} completed</div>
          </div>
        </div>
        <div class="task-side">
          <div class="earn">₦${userPay}</div>
          <small class="muted">per user</small>
          <div style="margin-top:10px">
            <button class="btn" id="open-${id}">Open Task</button>
            <button class="btn ghost" id="submit-${id}" style="margin-left:8px">Submit Proof</button>
          </div>
        </div>
      `;

      taskContainer.appendChild(card);

      document.getElementById(`open-${id}`).onclick = () => window.open(data.link || '#', '_blank');
      document.getElementById(`submit-${id}`).onclick = () => openProofModal(id, data, userPay);

      // live progress
      db.collection('task_submissions').where('taskId','==',id).where('status','==','approved')
        .onSnapshot(snap => {
          const done = snap.size;
          const total = data.workersNeeded || 1;
          const pct = Math.min(100, Math.round(done/total*100));
          const bar = document.getElementById(`pbar-${id}`);
          const label = document.getElementById(`plabel-${id}`);
          if (bar) bar.style.width = pct + '%';
          if (label) label.textContent = `${done} / ${total} completed`;
          if (done >= total) {
            const el = document.getElementById(`task-${id}`);
            if (el) el.remove();
          }
        });
    }

    function escapeHtml(s) { return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // ===== proof modal =====
    function openProofModal(taskId, data, payout) {
      openTask = { id: taskId, data, payout };
      modalTaskTitle.textContent = data.taskTitle || 'Task';
      proofText.value = '';
      proofFile.value = null;
      uploadIndicator.style.width = '0%';
      uploadPercent.textContent = '0%';
      proofModal.style.display = 'flex';
    }

    cancelModal.onclick = () => { proofModal.style.display = 'none'; };

    confirmSubmit.onclick = async () => {
      if (!openTask || !currentUser) return;
      const text = proofText.value.trim();
      const file = proofFile.files && proofFile.files[0];
      if (!text || !file) { alert('Please provide text proof and an image.'); return; }

      // disable while uploading
      confirmSubmit.disabled = true; confirmSubmit.textContent = 'Uploading...';
      try {
        const url = await uploadToImgur(file, p => {
          uploadIndicator.style.width = p + '%';
          uploadPercent.textContent = p + '%';
        });

        await db.collection('task_submissions').add({
          taskId: openTask.id,
          userId: currentUser.uid,
          username: currentUser.email || (currentUser.displayName || ''),
          textProof: text,
          imageProof: url,
          payout: openTask.payout,
          status: 'pending',
          submittedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // UI feedback
        proofModal.style.display = 'none';
        const taskEl = document.getElementById(`task-${openTask.id}`);
        if (taskEl) taskEl.remove();
        alert('Proof submitted. It will be reviewed by admin.');
        // after removing, recalc scale
        setTimeout(scaleToFit, 80);
      } catch (err) {
        console.error('submit error', err);
        alert('Submission failed: ' + (err.message || err));
      } finally {
        confirmSubmit.disabled = false; confirmSubmit.textContent = 'Submit Proof';
      }
    };

    // Imgur upload helper
    function uploadToImgur(file, onProgress) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64 = reader.result.split(',')[1];
          const form = new FormData();
          form.append('image', base64);
          const xhr = new XMLHttpRequest();
          xhr.open('POST', 'https://api.imgur.com/3/image');
          xhr.setRequestHeader('Authorization', 'Client-ID fb533db21a59486');
          xhr.upload.onprogress = e => { if (e.lengthComputable) onProgress(Math.round(e.loaded / e.total * 100)); };
          xhr.onload = () => {
            try {
              const j = JSON.parse(xhr.responseText);
              if (j && j.success) resolve(j.data.link);
              el
