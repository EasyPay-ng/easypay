<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EasyPay – Available Tasks</title>
  <style>
    body { margin: 0; padding: 20px; font-family: 'Segoe UI', sans-serif; background-color: #f8fff8; }
    header { text-align: center; color: #006400; font-size: 2em; margin-bottom: 20px; }
    #loading { text-align: center; color: #006400; font-size: 1.2em; margin-top: 20px; display: none; }
    .task { background: #fff; border: 1px solid #ccc; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .task h2 { margin: 0 0 10px; color: #006400; font-size: 1.5em; }
    .task p { margin: 8px 0; line-height: 1.4; }
    .progress-container { background: #eee; border-radius: 20px; overflow: hidden; margin: 10px 0; height: 16px; }
    .progress-bar { height: 100%; background: #28a745; width: 0%; transition: width 0.4s ease-in-out; }
    .progress-label { font-size: 12px; text-align: right; color: #004400; }
    .proof { margin-top: 15px; }
    .proof label { display: block; margin-bottom: 4px; font-weight: bold; }
    .proof textarea, .proof input[type=file] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 10px; }
    .submit-btn { padding: 8px 16px; background: #007700; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
    .upload-progress-container { background: #eee; border-radius: 10px; overflow: hidden; height: 10px; margin-bottom: 4px; display: none; }
    .upload-progress-bar { height: 100%; width: 0%; transition: width 0.2s ease; }
    .upload-progress-label { font-size: 11px; text-align: right; color: #004400; display: none; }
  </style>
</head>
<body>
  <header>EasyPay – Available Tasks</header>
  <div id="loading">Loading tasks...</div>
  <div id="taskContainer"></div>

  <!-- Firebase Firestore SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script>
    // Initialize Firebase (Firestore only)
    const firebaseConfig = {
      apiKey: "AIzaSyDRkip46Ql5KhNfuatWAcAxQzgP5VtQ8UY",
      authDomain: "easypay-6bce8.firebaseapp.com",
      projectId: "easypay-6bce8",
      storageBucket: "easypay-6bce8.appspot.com",
      messagingSenderId: "862671358267",
      appId: "1:862671358267:web:b243c7b69840ef918c8f1e",
      measurementId: "G-2FZKDQ47FZ"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const loadingEl = document.getElementById('loading');
    const taskContainer = document.getElementById('taskContainer');

    // 1) Load tasks
    function startTaskListener() {
      loadingEl.style.display = 'block';
      db.collection('tasks')
        .where('status', '==', 'approved')
        .onSnapshot(snapshot => {
          loadingEl.style.display = 'none';
          taskContainer.innerHTML = '';
          snapshot.docs.reverse().forEach(doc => renderTask(doc));
        });
    }

    // 2) Render each task with proof form
    function renderTask(doc) {
      const data = doc.data(), id = doc.id;
      const price = data.costPerUser || data.totalBudget / data.workersNeeded;
      const userPay = parseFloat((price * 0.7).toFixed(2));

      const div = document.createElement('div');
      div.className = 'task';
      div.id = `task-${id}`;
      div.innerHTML = `
        <h2>${data.taskTitle} — ${data.category}</h2>
        <p>${data.description || ''}</p>
        <p><strong>Earn:</strong> ₦${userPay}</p>
        <div class="progress-container"><div class="progress-bar" id="bar-${id}"></div></div>
        <div class="progress-label" id="label-${id}">0 / ${data.workersNeeded} completed</div>
        <button onclick="window.open('${data.link}','_blank')" style="padding:6px 12px; background:#006400; color:#fff; border:none; border-radius:6px; cursor:pointer;">Start Task</button>
        <div class="proof">
          <label>Text Proof:</label>
          <textarea id="text-${id}" placeholder="Enter text proof..."></textarea>
          <label>Upload Image Proof:</label>
          <input type="file" id="file-${id}" accept="image/*" />
          <div class="upload-progress-container" id="upload-container-${id}">
            <div class="upload-progress-bar" id="upload-bar-${id}"></div>
          </div>
          <div class="upload-progress-label" id="upload-label-${id}"></div>
          <button class="submit-btn" onclick="submitProof('${id}', ${userPay})">Submit Proof</button>
        </div>
      `;
      taskContainer.appendChild(div);

      // Track completion progress
      db.collection('task_submissions')
        .where('taskId','==',id)
        .onSnapshot(snap => {
          let done = 0;
          snap.forEach(s => { if (['approved','reviewed'].includes(s.data().status)) done++; });
          const pct = Math.min(100, Math.round((done / data.workersNeeded) * 100));
          document.getElementById(`bar-${id}`).style.width = pct + '%';
          document.getElementById(`label-${id}`).textContent = `${done} / ${data.workersNeeded} completed`;
          if (done >= data.workersNeeded) {
            document.getElementById(`task-${id}`)?.remove();
            db.collection('tasks').doc(id).update({ status: 'completed' });
          }
        });
    }

    // 3) Upload via your PHP endpoint with progress
    function uploadViaPhp(file, onProgress) {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', 'https://imageshostuploaded.xyz/uploadimage.php');
        xhr.upload.onprogress = evt => {
          if (evt.lengthComputable) {
            onProgress(Math.round((evt.loaded / evt.total) * 100));
          }
        };
        xhr.onload = () => {
          if (xhr.status === 200) {
            try {
              const res = JSON.parse(xhr.responseText);
              return resolve(res.imageUrl || '');
            } catch {
              return reject('Invalid JSON from server');
            }
          }
          reject('Upload failed: ' + xhr.status);
        };
        xhr.onerror = () => reject('Network error');
        const formData = new FormData();
        formData.append('image', file);
        xhr.send(formData);
      });
    }

    // 4) Submit proof: text + image, then store in Firestore
    async function submitProof(taskId, payout) {
      const textEl = document.getElementById(`text-${taskId}`);
      const fileEl = document.getElementById(`file-${taskId}`);
      const text = textEl.value.trim();
      const file = fileEl.files[0];
      const bar = document.getElementById(`upload-bar-${taskId}`);
      const label = document.getElementById(`upload-label-${taskId}`);
      const container = document.getElementById(`upload-container-${taskId}`);

      if (!text || !file) return alert('Please enter text proof and select an image');
      container.style.display = 'block';
      label.style.display = 'block';

      try {
        const imageUrl = await uploadViaPhp(file, pct => {
          bar.style.width = pct + '%';
          label.textContent = pct + '%';
        });
        // Using anonymous placeholder userId; replace with real UID if you have auth
        const userId = 'public_' + Date.now();
        await db.collection('task_submissions').add({
          taskId, userId, textProof: text, imageProof: imageUrl,
          payout, status: 'pending', submittedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        label.textContent = 'Submitted!';
        setTimeout(() => {
          container.style.display = 'none';
          label.style.display = 'none';
          bar.style.width = '0%';
        }, 1000);
        textEl.value = '';
        fileEl.value = null;
      } catch (err) {
        label.textContent = 'Error: ' + err;
      }
    }

    // Start loading tasks immediately
    startTaskListener();
  </script>
</body>
</html>
