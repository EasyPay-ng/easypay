<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Available Tasks</title>
  <style>
    /* (All the styling stays as you had it: fonts, layout, task cards, input fields, etc.) */
    /* If you'd like me to read out any section of this or adjust styling, just let me know. */
  </style>
</head>
<body>
  <div id="loginDiv">
    <h2>Please Sign In to Continue</h2>
    <input type="email" id="email" placeholder="Email" /><br />
    <input type="password" id="password" placeholder="Password" /><br />
    <button id="loginBtn">Sign In</button>
    <p id="loginError" style="color:red;"></p>
  </div>
  <div id="app" style="display:none">
    <header>Available Tasks</header>
    <button style="float:right; margin-bottom:10px;" id="logoutBtn">Sign Out</button>
    <div id="taskContainer"></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDRkip46Ql5KhNfuatWAcAxQzgP5VtQ8UY",
      authDomain: "easypay-6bce8.firebaseapp.com",
      projectId: "easypay-6bce8",
      storageBucket: "easypay-6bce8.appspot.com",
      messagingSenderId: "862671358267",
      appId: "1:862671358267:web:b243c7b69840ef918c8f1e"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(), db = firebase.firestore(), storage = firebase.storage();

    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const emailInput = document.getElementById("email");
    const passInput = document.getElementById("password");
    const loginError = document.getElementById("loginError");
    const taskContainer = document.getElementById("taskContainer");

    loginBtn.onclick = () => {
      loginError.textContent = "";
      auth.signInWithEmailAndPassword(emailInput.value, passInput.value).catch(e => {
        loginError.textContent = e.message;
      });
    };
    logoutBtn.onclick = () => auth.signOut();

    auth.onAuthStateChanged(user => {
      if (user) {
        document.getElementById("loginDiv").style.display = "none";
        document.getElementById("app").style.display = "block";
        startTaskListener();
      } else {
        document.getElementById("loginDiv").style.display = "block";
        document.getElementById("app").style.display = "none";
        taskContainer.innerHTML = "";
      }
    });

    function startTaskListener() {
      db.collection("tasks").where("status", "==", "approved").onSnapshot(snapshot => {
        taskContainer.innerHTML = "";
        snapshot.docs.slice().reverse().forEach(doc => renderTask(doc));
      });
    }

    function renderTask(doc) {
      const data = doc.data();
      const id = doc.id;
      const userPay = parseFloat(((data.costPerUser || data.totalBudget / data.workersNeeded) * 0.7).toFixed(2));
      const div = document.createElement("div");
      div.className = "task";
      div.id = `task-${id}`;
      div.innerHTML = `
        <h2>${data.taskTitle} — ${data.category}</h2>
        <p>${data.description || ""}</p>
        <p><strong>Earn:</strong> ₦${userPay}</p>
        <div class="progress-container"><div class="progress-bar" id="bar-${id}"></div></div>
        <div class="progress-label" id="label-${id}">0 / ${data.workersNeeded} completed</div>
        <button onclick="window.open('${data.link}','_blank')">Start Task</button>
        <div class="proof">
          <label>Text Proof:</label>
          <textarea id="text-${id}" placeholder="Enter text proof..."></textarea>
          <label>Upload Image Proof:</label>
          <input type="file" id="file-${id}" accept="image/*" />
          <div class="progress-label" id="upload-status-${id}"></div>
          <button class="submit-btn" onclick="submitProof('${id}', ${userPay})">Submit Proof</button>
        </div>
      `;
      taskContainer.appendChild(div);

      db.collection("task_submissions").where("taskId", "==", id).onSnapshot(snap => {
        let completed = 0;
        snap.forEach(sub => {
          const s = sub.data().status;
          if (s === "approved" || s === "reviewed") completed++;
        });
        const pct = Math.min(100, Math.round((completed / data.workersNeeded) * 100));
        document.getElementById(`bar-${id}`).style.width = pct + "%";
        document.getElementById(`label-${id}`).textContent = `${completed} / ${data.workersNeeded} completed`;
        if (completed >= data.workersNeeded) {
          document.getElementById(`task-${id}`)?.remove();
          db.collection("tasks").doc(id).update({ status: "completed" });
        }
      });
    }

    async function submitProof(taskId, payout) {
      const user = auth.currentUser;
      if (!user) return alert("Please sign in first.");
      const text = document.getElementById(`text-${taskId}`).value.trim();
      const fileInput = document.getElementById(`file-${taskId}`);
      const file = fileInput.files[0];
      const statusLabel = document.getElementById(`upload-status-${taskId}`);
      if (!text || !file) return alert("Fill in text proof and choose an image.");

      const filePath = `proof_images/${user.uid}_${Date.now()}_${file.name}`;
      const storageRef = storage.ref(filePath);
      const uploadTask = storageRef.put(file);

      uploadTask.on('state_changed', snapshot => {
        const progress = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
        statusLabel.textContent = `Uploading: ${progress}%`;
      }, err => {
        statusLabel.textContent = "Upload failed. Try again.";
      }, async () => {
        const imageUrl = await uploadTask.snapshot.ref.getDownloadURL();
        await db.collection("task_submissions").add({
          taskId,
          userId: user.uid,
          textProof: text,
          imageProof: imageUrl,
          payout,
          status: "pending",
          submittedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        statusLabel.textContent = "Submitted successfully!";
        document.getElementById(`text-${taskId}`).value = "";
        fileInput.value = "";
      });
    }
  </script>
</body>
</html>
