<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Choose Your Plan – EasyPay</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

  <style>
    /* (kept the responsive CSS from the last version unchanged) */
    :root{
      --bg: #f5fdf7;
      --green: #009f4d;
      --green-dark: #007a33;
      --card: #ffffff;
      --muted: #556064;
      --accent-gold: #c79b1b;
      --shadow-1: 0 6px 18px rgba(2, 48, 22, 0.06);
      --radius: 12px;
      --gap: 14px;
      --max-width: 1200px;
    }
    * { box-sizing: border-box; }
    html,body{height:100%; margin:0;}
    body{
      font-family: 'Poppins', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg,#f7fff9 0%,var(--bg) 100%);
      color:#173231;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      display:flex;
      flex-direction:column;
      min-height:100vh;
      line-height:1.32;
    }

    header{
      padding:18px clamp(12px, 3vw, 28px);
      background: linear-gradient(90deg, rgba(0,159,77,0.96), rgba(5,125,66,0.95));
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      box-shadow: 0 6px 14px rgba(3,64,30,0.07);
      flex-wrap:wrap;
    }
    header .left { display:flex; gap:12px; align-items:center; }
    header h1 { margin:0; font-size: clamp(1.0rem, 1.6vw, 1.25rem); font-weight:700; letter-spacing:-0.4px; }
    header p.sub { margin:0; font-size: clamp(0.82rem, 1.1vw, 0.95rem); opacity:0.95; font-weight:500; }

    .header-right { display:flex; gap:12px; align-items:center; margin-left:auto; }
    .balance-chip { background: rgba(255,255,255,0.08); padding:8px 12px; border-radius:999px; font-weight:700; color:#fff; display:flex; gap:8px; align-items:center; font-size: clamp(0.8rem, 1.1vw, 0.95rem); }

    .page { width:100%; max-width: var(--max-width); margin: 12px auto; padding: 0 clamp(12px, 3vw, 28px) 36px; flex:1; }

    .top-notes { display:flex; gap:var(--gap); align-items:flex-start; justify-content:space-between; flex-wrap:wrap; margin: 12px 0; }
    .note, .danger { padding:10px 12px; border-radius:8px; box-shadow:var(--shadow-1); min-height:44px; display:flex; gap:10px; align-items:center; flex: 1 1 48%; font-weight:600; font-size:clamp(0.86rem, 1.1vw, 0.93rem); line-height:1.12; }
    .note { background:#fff; border-left:4px solid var(--green); color:var(--muted); min-width:220px; }
    .note small { display:block; margin-top:6px; font-size:0.86rem; color:#5a6b64; font-weight:600; }
    .danger { background: linear-gradient(180deg,#fff6f3,#fff8f5); border:1px solid rgba(255,122,66,0.08); color:#7a2a1a; box-shadow:0 6px 14px rgba(204,80,48,0.05); min-width:200px; flex: 1 1 40%; }
    .danger .title { color:#b32305; font-size:0.92rem; font-weight:800; }

    .plans { display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: clamp(10px, 2.2vw, 20px); margin-top:18px; align-items:start; }
    .plan-card { background: linear-gradient(180deg, rgba(255,255,255,0.98), var(--card)); border-radius:12px; padding:18px; box-shadow: var(--shadow-1); display:flex; flex-direction:column; gap:12px; border: 1px solid rgba(4,90,40,0.03); transition: transform .14s ease, box-shadow .14s ease; min-height:auto; }
    .plan-card:hover { transform: translateY(-6px); box-shadow: 0 14px 30px rgba(6,84,40,0.06); }
    .plan-top { display:flex; align-items:center; gap:10px; width:100%; }
    .badge { width: clamp(44px, 6vw, 56px); height: clamp(44px, 6vw, 56px); border-radius:10px; display:flex; align-items:center; justify-content:center; font-weight:800; color:#fff; font-size: clamp(14px, 2.2vw, 18px); flex-shrink:0; }
    .badge.premium { background: linear-gradient(180deg,#15a65b,#078343); }
    .badge.gold { background: linear-gradient(180deg,#d0a33e,#b88617); color:#2b1f05; }
    .badge.elite { background: linear-gradient(180deg,#6f22a7,#4b0d86); }
    .badge.diamond { background: linear-gradient(180deg,#00aaff,#0057b8); color:#fff; }

    .plan-header { font-size: clamp(1rem, 1.8vw, 1.15rem); font-weight:700; color:#123824; }
    .plan-price { font-size: clamp(1.15rem, 2.8vw, 1.6rem); font-weight:800; color:var(--green-dark); margin-top:4px; }
    .plan-duration { color:var(--muted); font-weight:600; margin-top:4px; font-size: clamp(.82rem, 1.2vw, .92rem); }
    .plan-desc { color:#27423a; margin-top:8px; line-height:1.35; font-weight:600; text-align:center; padding: 0 6px; font-size: clamp(.9rem, 1.4vw, .95rem); }
    .plan-features { list-style:none; padding:0; margin:10px 0 0; display:flex; flex-direction:column; gap:8px; align-items:flex-start; color:var(--muted); font-weight:600; font-size: clamp(.86rem, 1.1vw, .92rem); }
    .plan-features li { display:flex; gap:8px; align-items:center; }
    .plan-features li i { color:var(--green); min-width:18px; text-align:center; font-size:12px; }
    .plan-footer { display:flex; gap:12px; align-items:center; justify-content:center; margin-top:6px; }
    .upgrade-btn { background:var(--green); color:#fff; border:0; padding:10px 14px; border-radius:10px; box-shadow: 0 6px 16px rgba(2,95,47,0.10); font-weight:700; cursor:pointer; width:100%; max-width:240px; font-size: clamp(.88rem, 1.5vw, .98rem); }
    .upgrade-btn.gold { background: linear-gradient(90deg,var(--accent-gold), #b88617); color:#2b1f05; box-shadow: 0 8px 20px rgba(184,134,23,0.10); }
    .upgrade-btn.elite { background: linear-gradient(90deg,#7b3ad6,#5b13b0); color:#fff; box-shadow: 0 8px 20px rgba(91,19,176,0.10); }
    .upgrade-btn.diamond { background: linear-gradient(90deg,#00b6ff,#0066cc); color:#fff; box-shadow: 0 8px 26px rgba(0,102,204,0.12); }

    .tag { display:inline-block; padding:6px 8px; border-radius:999px; font-weight:700; background:rgba(0,159,77,0.08); color:var(--green-dark); font-size:0.82rem; }
    footer { text-align:center; padding:12px 10px; color:var(--muted); font-size:0.92rem; margin-top:14px; }
    .msg { padding:10px;border-radius:10px;margin-bottom:12px; font-weight:700 }
    .msg.info { background:#eefbf2; color:#1b5b32; border:1px solid rgba(2,120,60,0.06) }
    .msg.error { background:#fff6f3;color:#7a2a1a;border:1px solid rgba(204,80,48,0.06) }

    @media (max-width:720px) {
      header { align-items:flex-start; padding:14px; }
      .header-right { width:100%; justify-content:flex-start; margin-top:8px; }
      .balance-chip { width:100%; justify-content:flex-start; padding:10px; }
      .top-notes { gap:10px; flex-direction:column; }
      .note, .danger { flex: 1 1 auto; width:100%; }
      .plans { grid-template-columns: 1fr; gap:12px; margin-top:12px; }
      .plan-card { padding:14px; }
      .plan-desc { text-align:left; }
      .plan-footer { flex-direction:column; }
      .upgrade-btn { max-width:100%; width:100%; padding:12px; }
    }
    @media (min-width:721px) and (max-width:1024px) { .plans { grid-template-columns: repeat(2, 1fr); gap:16px; } .badge { width:52px; height:52px; } }
    @media (min-width:1025px) { .page { padding: 0 28px 48px; } .plans { grid-template-columns: repeat(3, 1fr); gap:20px; } .plans { align-items:stretch; } .plan-card { display:flex; flex-direction:column; justify-content:space-between; } }
  </style>
</head>
<body>
  <header role="banner" aria-label="Page header">
    <div class="left">
      <h1>Choose Your Activation Plan</h1>
      <div class="tag" aria-hidden="true" style="margin-left:8px">30 days</div>
    </div>

    <div class="header-right" aria-hidden="false">
      <div>
        <p class="sub" style="margin:0">Activate & start earning</p>
        <div id="userBalanceChip" class="balance-chip" aria-live="polite">Balance: ₦0.00</div>
      </div>
    </div>
  </header>

  <main class="page" role="main">
    <div id="messageArea"></div>

    <div class="top-notes" aria-live="polite">
      <div class="note" role="status" aria-atomic="true">
        <i class="fas fa-bolt" style="color:var(--green);font-size:18px;"></i>
        <div>
          <div style="font-weight:800;color:#184d36;font-size:0.98rem">Activation in ≤ 12 hours</div>
          <small>Payments & proof verified — activation completed (max 12 hours, do not make more than 1 request within 12hrs).</small>
        </div>
      </div>

      <div class="danger" role="alert" aria-atomic="true">
        <i class="fas fa-exclamation-triangle" style="color:#b32305;font-size:18px;"></i>
        <div style="margin-left:6px">
          <div class="title">Duplicate activations not allowed</div>
          <div style="font-weight:700;font-size:0.92rem">If an activated user submits another activation request their account will be downgraded & disabled with no room for appeal.</div>
        </div>
      </div>
    </div>

    <section class="plans" aria-label="Available plans">

      <!-- Premium -->
      <article class="plan-card" aria-labelledby="premiumTitle">
        <div>
          <div class="plan-top">
            <div class="badge premium" aria-hidden="true">P</div>
            <div style="flex:1">
              <div id="premiumTitle" class="plan-header">Premium</div>
              <div class="plan-price"><span class="naira">₦</span>3,000</div>
              <div class="plan-duration">Valid for 30 days</div>
            </div>
          </div>

          <p class="plan-desc">Affordable starter plan — steady daily earnings to build momentum. Great for new users wanting fast returns.</p>

          <ul class="plan-features" aria-hidden="false">
            <li><i class="fas fa-check-circle"></i> Ideal for newcomers</li>
            <li><i class="fas fa-check-circle"></i> Quick activation (≤12h)</li>
            <li><i class="fas fa-check-circle"></i> Full support during activation</li>
          </ul>
        </div>

        <div class="plan-footer" aria-hidden="false">
          <button class="upgrade-btn" data-cost="3000" data-plan="premium" data-label="Premium" data-daily="100" aria-label="Activate Premium plan">Activate Premium — ₦3,000</button>
        </div>
      </article>

      <!-- Diamond -->
      <article class="plan-card" aria-labelledby="diamondTitle">
        <div>
          <div class="plan-top">
            <div class="badge diamond" aria-hidden="true">D</div>
            <div style="flex:1">
              <div id="diamondTitle" class="plan-header">Diamond</div>
              <div class="plan-price"><span class="naira">₦</span>20,000</div>
              <div class="plan-duration">Valid for 30 days</div>
            </div>
          </div>

          <p class="plan-desc"><strong>₦1,600 daily.</strong> Diamond is a high-tier activation that pays ₦1,600 per day for 30 days — best for serious earners.</p>

          <ul class="plan-features" aria-hidden="false">
            <li><i class="fas fa-check-circle"></i> Earn ₦1,600 daily (₦48,000 over 30 days)</li>
            <li><i class="fas fa-check-circle"></i> Priority activation & VIP support</li>
            <li><i class="fas fa-check-circle"></i> Best ROI for high-activity users</li>
          </ul>
        </div>

        <div class="plan-footer" aria-hidden="false">
          <button class="upgrade-btn diamond" data-cost="20000" data-plan="diamond" data-label="Diamond" data-daily="1600" aria-label="Activate Diamond plan">Activate Diamond — ₦20,000</button>
        </div>
      </article>

      <!-- Elite -->
      <article class="plan-card" aria-labelledby="eliteTitle">
        <div>
          <div class="plan-top">
            <div class="badge elite" aria-hidden="true">E</div>
            <div style="flex:1">
              <div id="eliteTitle" class="plan-header">Elite</div>
              <div class="plan-price"><span class="naira">₦</span>10,000</div>
              <div class="plan-duration">Valid for 30 days</div>
            </div>
          </div>

          <p class="plan-desc"><strong>Earn ₦700 daily.</strong> Elite is a monthly activation that pays ₦700 per day for 30 days. Designed for users seeking higher daily returns.</p>

          <ul class="plan-features" aria-hidden="false">
            <li><i class="fas fa-check-circle"></i> Earn ₦700 daily (₦21,000 over 30 days)</li>
            <li><i class="fas fa-check-circle"></i> monthly activation period (30 days)</li>
            <li><i class="fas fa-check-circle"></i> Priority activation & support</li>
          </ul>
        </div>

        <div class="plan-footer" aria-hidden="false">
          <button class="upgrade-btn elite" data-cost="10000" data-plan="elite" data-label="Elite" data-daily="700" aria-label="Activate Elite plan">Activate Elite — ₦10,000</button>
        </div>
      </article>

      <!-- Gold -->
      <article class="plan-card" aria-labelledby="goldTitle">
        <div>
          <div class="plan-top">
            <div class="badge gold" aria-hidden="true"><i class="fas fa-crown" style="font-size:18px;"></i></div>
            <div style="flex:1">
              <div id="goldTitle" class="plan-header">Gold</div>
              <div class="plan-price"><span class="naira">₦</span>6,000</div>
              <div class="plan-duration">Valid for 30 days</div>
            </div>
          </div>

          <p class="plan-desc"><strong>₦6,000 to earn ₦400 daily.</strong> High-yield plan for users who want a strong daily return over the 30-day activation period.</p>

          <ul class="plan-features" aria-hidden="false">
            <li><i class="fas fa-check-circle"></i> Earn ₦400 daily</li>
            <li><i class="fas fa-check-circle"></i> Priority activation (≤12h)</li>
            <li><i class="fas fa-check-circle"></i> Recommended for experienced users</li>
          </ul>
        </div>

        <div class="plan-footer" aria-hidden="false">
          <button class="upgrade-btn gold" data-cost="6000" data-plan="gold" data-label="Gold" data-daily="400" aria-label="Activate Gold plan">Activate Gold — ₦6,000</button>
        </div>
      </article>

    </section>
  </main>

  <footer role="contentinfo">© 2025 EasyPay • Activation processed within 12 hours</footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      runTransaction,
      serverTimestamp,
      onSnapshot,
      getDoc
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // Beni-Wealth Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDy_L7uJeoaWXbUB-LVk_fBv8yHeRjNjZk",
      authDomain: "beni-wealths.firebaseapp.com",
      projectId: "beni-wealths",
      storageBucket: "beni-wealths.firebasestorage.app",
      messagingSenderId: "807950483822",
      appId: "1:807950483822:web:e10fa87307e041c4d8417f",
      measurementId: "G-Z2XP3YN6NS"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI refs
    const messageArea = document.getElementById('messageArea');
    const userBalanceChip = document.getElementById('userBalanceChip');

    function showMessage(text, type = 'info') {
      messageArea.innerHTML = `<div class="msg ${type === 'error' ? 'error' : 'info'}" role="status" aria-live="polite">${text}</div>`;
      setTimeout(() => {
        if (messageArea.firstChild) messageArea.removeChild(messageArea.firstChild);
      }, 6000);
    }

    function formatN(n) {
      const num = Number(n || 0);
      return '₦' + num.toLocaleString('en-NG', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // state
    let currentUid = null;
    let balanceUnsub = null;
    let authFirstCallbackSeen = false;
    let snapshotResponded = false; // has snapshot fired at least once?

    // attach plan button listeners (programmatic fallback)
    function wirePlanButtons() {
      const buttons = document.querySelectorAll('.upgrade-btn');
      buttons.forEach(btn => {
        // avoid double-wiring
        if (btn._wired) return;
        btn._wired = true;
        btn.addEventListener('click', (e) => {
          // read dataset safely
          const cost = Number(btn.dataset.cost || 0);
          const planId = String(btn.dataset.plan || '');
          const label = String(btn.dataset.label || planId);
          const daily = Number(btn.dataset.daily || 0);
          activatePlan(cost, planId, label, daily).catch(err => {
            console.error('activatePlan error (from event)', err);
          });
        });
      });
    }

    // transaction activation (same atomic flow)
    async function activatePlan(cost, planId, planLabel, dailyEarning) {
      if (!currentUid) {
        showMessage('Sign in required to activate a plan.', 'error');
        return;
      }

      // simple UI confirm
      const ok = confirm(`Activate ${planLabel} for ${formatN(cost)}? This will deduct from your balance.`);
      if (!ok) return;

      const userRef = doc(db, 'users', currentUid);

      try {
        await runTransaction(db, async (tx) => {
          const snap = await tx.get(userRef);
          if (!snap.exists()) {
            throw new Error('User record not found.');
          }
          const data = snap.data();
          const curBal = Number(data.balance ?? 0);

          if (curBal < cost) {
            throw { code: 'insufficient-funds', message: `Insufficient balance: ${formatN(curBal)} — activation costs ${formatN(cost)}.` };
          }

          const newBal = Number((curBal - cost).toFixed(2));
          const now = Date.now();
          const expiresAt = now + (30 * 24 * 60 * 60 * 1000);

          tx.update(userRef, {
            balance: newBal,
            plan: planId,
            planLabel: planLabel,
            planActivatedAt: serverTimestamp(),
            planExpiresAt: expiresAt,
            dailyEarning: dailyEarning,
            status: 'active'
          });
        });

        showMessage(`${planLabel} activated successfully — ${formatN(cost)} deducted from your balance.`, 'info');
      } catch (err) {
        if (err && err.code === 'insufficient-funds') {
          showMessage(err.message, 'error');
          if (confirm('Your balance is insufficient. Would you like to recharge now?')) {
            window.location.href = 'recharge.html';
          }
        } else {
          console.error('Activation error', err);
          showMessage('Activation failed — see console for details.', 'error');
        }
      }
    }

    // ensure plan buttons wired early so clicks never get lost
    document.addEventListener('DOMContentLoaded', () => {
      wirePlanButtons();
    });

    // Auth + balance wiring with robust fallback
    onAuthStateChanged(auth, async (user) => {
      console.log('onAuthStateChanged ->', user ? user.uid : null);
      if (user) {
        authFirstCallbackSeen = true;
        currentUid = user.uid;

        // wire buttons again (in case DOM was updated)
        wirePlanButtons();

        // unsubscribe previous snapshot
        if (balanceUnsub) { try { balanceUnsub(); } catch(e){}; balanceUnsub = null; }
        snapshotResponded = false;

        const userRef = doc(db, 'users', user.uid);

        // set up realtime listener
        try {
          balanceUnsub = onSnapshot(userRef, (snap) => {
            snapshotResponded = true;
            if (snap.exists()) {
              const data = snap.data();
              const bal = Number(data.balance ?? 0);
              userBalanceChip.textContent = `Balance: ${formatN(bal)}`;
            } else {
              userBalanceChip.textContent = `Balance: ${formatN(0)}`;
          
